# –û—Ç—á–µ—Ç –æ –ø–æ–ª–Ω–æ–º –∞—É–¥–∏—Ç–µ –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ –º–æ–¥–µ–ª–µ–π SQLAlchemy

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–µ–π –∏ –Ω–∞—Å–ª–µ–¥–∏—è
- **–°—Ç–∞—Ç—É—Å**: –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: 
  - `TopTheme` –∏ `GlobalTheme` - —ç—Ç–æ **–ù–ï –¥—É–±–ª–∏**, –∞ —Ä–∞–∑–Ω—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–ª–µ–π
  - `TopTheme` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç–æ–ø-—Ç–µ–º –ø–æ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `GlobalTheme` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
  - –û–±–µ –º–æ–¥–µ–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –∫–æ–¥–æ–≤–æ–π –±–∞–∑–µ

### 2. –†–µ–≤–∏–∑–∏—è –º–æ–¥–µ–ª–∏ User –∏ –µ—ë —Å–≤—è–∑–µ–π
- **–°—Ç–∞—Ç—É—Å**: –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –ü–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –Ω–∞ SQLAlchemy 2.0 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å (`Mapped`, `mapped_column`)
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞—Å–∫–∞–¥—ã –¥–ª—è –≤—Å–µ—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤:
    ```python
    subscriptions: Mapped[list["Subscription"]] = relationship(
        back_populates="user", 
        cascade="all, delete-orphan"
    )
    limits: Mapped["Limits"] = relationship(
        back_populates="user", 
        uselist=False,
        cascade="all, delete-orphan"
    )
    csv_analyses: Mapped[list["CSVAnalysis"]] = relationship(
        back_populates="user",
        cascade="all, delete-orphan"
    )
    theme_requests: Mapped[list["ThemeRequest"]] = relationship(
        back_populates="user",
        cascade="all, delete-orphan"
    )
    issued_themes: Mapped[list["UserIssuedTheme"]] = relationship(
        back_populates="user",
        cascade="all, delete-orphan"
    )
    ```
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ç–∏–ø `telegram_id` –Ω–∞ `BigInteger` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –±–æ–ª—å—à–∏–º–∏ ID

### 3. –†–µ–≤–∏–∑–∏—è ForeignKey –∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤–æ –≤—Å–µ—Ö –º–æ–¥–µ–ª—è—Ö
- **–°—Ç–∞—Ç—É—Å**: –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
  - –í—Å–µ –º–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ SQLAlchemy 2.0 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
  - **–í—Å–µ ForeignKey –∫–æ–ª–æ–Ω–∫–∏ –ø–æ–ª—É—á–∏–ª–∏ `index=True`**:
    - `subscription.user_id` ‚Üí `index=True`
    - `limits.user_id` ‚Üí `index=True`
    - `csv_analysis.user_id` ‚Üí `index=True`
    - `theme_request.user_id` ‚Üí `index=True`
    - `top_theme.csv_analysis_id` ‚Üí `index=True`
    - `analytics_report.csv_analysis_id` ‚Üí `index=True`
    - `user_issued_theme.user_id` ‚Üí `index=True`
    - `user_issued_theme.theme_id` ‚Üí `index=True`
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 4. –†–µ–≤–∏–∑–∏—è relationship –≤–æ –≤—Å–µ—Ö –º–æ–¥–µ–ª—è—Ö
- **–°—Ç–∞—Ç—É—Å**: –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
  - **–í—Å–µ relationships —Ç–µ–ø–µ—Ä—å –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ** —Å `back_populates`
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏:
    - –î–æ–±–∞–≤–ª–µ–Ω `issued_themes` –≤ –º–æ–¥–µ–ª—å `User`
    - –î–æ–±–∞–≤–ª–µ–Ω `issued_to_users` –≤ –º–æ–¥–µ–ª—å `GlobalTheme`
    - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã `back_populates` –≤ `UserIssuedTheme`
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞—Å–∫–∞–¥—ã –¥–ª—è –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤:
    - `CSVAnalysis.top_themes` ‚Üí `cascade="all, delete-orphan"`
    - `GlobalTheme.issued_to_users` ‚Üí `cascade="all, delete-orphan"`

### 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic
- **–°—Ç–∞—Ç—É—Å**: –ó–∞–≤–µ—Ä—à–µ–Ω–æ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: 
  - –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `3d4a9c658cf9_schema_audit_add_indexes_set_cascades_.py`
  - –ú–∏–≥—Ä–∞—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç:
    - –°–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
    - –í—Å–µ ForeignKey –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
    - –í—Å–µ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ (17 —Ñ–∞–π–ª–æ–≤):
1. `user.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞—Å–∫–∞–¥—ã, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω —Ç–∏–ø telegram_id
2. `subscription.py` - –¥–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ user_id
3. `limits.py` - –¥–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ user_id
4. `csv_analysis.py` - –¥–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ user_id, –∫–∞—Å–∫–∞–¥—ã –¥–ª—è top_themes
5. `theme_request.py` - –¥–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ user_id
6. `top_theme.py` - –¥–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ csv_analysis_id
7. `global_theme.py` - –¥–æ–±–∞–≤–ª–µ–Ω relationship —Å –∫–∞—Å–∫–∞–¥–æ–º
8. `user_issued_theme.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã back_populates
9. `analytics_report.py` - –¥–æ–±–∞–≤–ª–µ–Ω –∏–Ω–¥–µ–∫—Å –Ω–∞ csv_analysis_id
10. `video_lesson.py` - –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ SQLAlchemy 2.0
11. `calendar_entry.py` - –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ SQLAlchemy 2.0
12. `broadcast_message.py` - –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ SQLAlchemy 2.0
13. `audit_log.py` - –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ SQLAlchemy 2.0
14. `llm_settings.py` - –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ SQLAlchemy 2.0
15. `asset_details.py` - –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –Ω–∞ SQLAlchemy 2.0

### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã:
- **8 ForeignKey –∏–Ω–¥–µ–∫—Å–æ–≤** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ JOIN –∑–∞–ø—Ä–æ—Å–æ–≤
- **–°–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã** —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã** –Ω–∞ telegram_id, asset_id, log_id

### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–∞—Å–∫–∞–¥—ã:
- **5 –∫–∞—Å–∫–∞–¥–æ–≤** –≤ –º–æ–¥–µ–ª–∏ User –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ—á–µ—Ä–Ω–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
- **2 –∫–∞—Å–∫–∞–¥–∞** –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥–µ–ª—è—Ö –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
1. **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —á–∏—Å—Ç–æ—Ç–∞**: –í—Å–µ –º–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ SQLAlchemy 2.0 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –í—Å–µ ForeignKey –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
3. **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞—Å–∫–∞–¥—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
4. **–î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏**: –í—Å–µ relationships –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ back_populates

### üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ Supabase:
- –°—Ö–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –ø–µ—Ä–µ–Ω–æ—Å—É –≤ PostgreSQL/Supabase
- –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ö–∞—Å–∫–∞–¥—ã –æ–±–µ—Å–ø–µ—á–∞—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- SQLAlchemy 2.0 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

### üìù –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞:
- –§–∞–π–ª: `database/migrations/versions/3d4a9c658cf9_schema_audit_add_indexes_set_cascades_.py`
- –í–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ö–µ–º—ã
- –ì–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é –≤ Supabase

**–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Supabase!** üéâ
