# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π UX:
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç **–ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å—Ä–∞–∑—É** –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ CSV
- ‚úÖ **–ù–∏–∫–∞–∫–∏—Ö** –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –≤ –º–µ–Ω—é ‚Äî –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –í—Å–µ —Ç–µ–∫—Å—Ç—ã –≤ `LEXICON_RU` (–±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞)

### –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ Dramatiq (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –±–æ—Ç–∞)
- ‚úÖ Pandas chunks (—ç–∫–æ–Ω–æ–º–∏—è RAM)
- ‚úÖ Supabase Storage (–∑–∞—â–∏—Ç–∞ –æ—Ç —ç—Ñ–µ–º–µ—Ä–Ω–æ–≥–æ –¥–∏—Å–∫–∞)
- ‚úÖ Rate limiting (10 —Ñ–∞–π–ª–æ–≤/—á–∞—Å)

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### 1. –ò—Å–ø—Ä–∞–≤—å Supabase Storage Policy (5 –º–∏–Ω—É—Ç)

**–ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ:** `syntax error at or near ";"`

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π https://supabase.com/dashboard/project/tqydndcvjqigxvjmaacj/storage/buckets/csv-files
2. –ü–µ—Ä–µ–π–¥–∏ –≤ **Policies** ‚Üí **New policy**
3. –ó–∞–ø–æ–ª–Ω–∏:
   - **Policy name**: `Service Role Full Access`
   - **Allowed operations**: SELECT, INSERT, UPDATE, DELETE (–≤—Å–µ!)
   - **Target roles**: `service_role`
   - **USING**: `bucket_id = 'csv-files'`  (–ë–ï–ó `CREATE POLICY` –∏ —Ç–æ—á–∫–∏ —Å –∑–∞–ø—è—Ç–æ–π!)
   - **WITH CHECK**: `bucket_id = 'csv-files'`
4. –ù–∞–∂–º–∏ **"Save policy"**

**–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è**: `docs/SUPABASE_POLICY_FIX.md`

---

### 2. –ó–∞–∫–æ–º–º–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
git add .
git commit -m "fix: restore original UX for CSV analytics (send full report immediately)"
git push origin test/high-load-optimization
```

---

### 3. Smoke Test (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, 5 –º–∏–Ω—É—Ç)

1. –û—Ç–∫—Ä–æ–π Telegram ‚Üí —Ç–≤–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π –±–æ—Ç
2. –û—Ç–ø—Ä–∞–≤—å `/start`
3. –ü–µ—Ä–µ–π–¥–∏ –≤ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è"
4. –ó–∞–≥—Ä—É–∑–∏ —Ç–µ—Å—Ç–æ–≤—ã–π CSV —Ñ–∞–π–ª
5. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –±–æ—Ç–∞ (—Ä–∞–∑–º–µ—Ä –ø–æ—Ä—Ç—Ñ–µ–ª—è, –ª–∏–º–∏—Ç—ã, etc.)
6. **–ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ:**
   - ‚úÖ –ü–æ—è–≤–∏–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–µ: "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞! –ú—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–≤–æ–π —Ñ–∞–π–ª..."
   - ‚úÖ –ß–µ—Ä–µ–∑ 1-2 –º–∏–Ω—É—Ç—ã –ø—Ä–∏—Ö–æ–¥–∏—Ç: "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!"
   - ‚úÖ **–°–†–ê–ó–£ –ñ–ï** –ø—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π HTML –æ—Ç—á–µ—Ç —Å–æ –≤—Å–µ–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
   - ‚úÖ –ï—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
   - ‚úÖ **–ù–ï –ù–£–ñ–ù–û** –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤ –º–µ–Ω—é —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ—Ç—á–µ—Ç

**–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî UX –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! üéâ**

---

## üìä –ö–∞–∫ –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –æ—Ç—á–µ—Ç

–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç **2 —Å–æ–æ–±—â–µ–Ω–∏—è**:

### –°–æ–æ–±—â–µ–Ω–∏–µ 1 (–≤–≤–æ–¥–Ω–æ–µ):
```
‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!

–¢–≤–æ–π –æ—Ç—á–µ—Ç –≥–æ—Ç–æ–≤. –°–º–æ—Ç—Ä–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∏–∂–µ üëá
```

### –°–æ–æ–±—â–µ–Ω–∏–µ 2 (–ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç):
```
üìä –û–¢–ß–Å–¢ –ó–ê –Ø–Ω–≤–∞—Ä—å 2024 –ì–û–¢–û–í! üìä

–ü—Ä–æ–¥–∞–∂ - 45
–î–æ—Ö–æ–¥ - $523.50
–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ - $11.63
% –ø–æ—Ä—Ç—Ñ–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–¥–∞–ª—Å—è –∑–∞ –º–µ—Å—è—Ü - 3.45%
–¥–æ–ª—è –ø—Ä–æ–¥–∞–∂ –Ω–æ–≤—ã—Ö —Ä–∞–±–æ—Ç - 67.23%

===============================
üìù –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
===============================
<b>% –ø–æ—Ä—Ç—Ñ–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–¥–∞–ª—Å—è –∑–∞ –º–µ—Å—è—Ü - 3.45%</b>

–≠—Ç–∞ –º–µ—Ç—Ä–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç...
[... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –æ—Ç—á–µ—Ç–∞ ...]

[–ö–Ω–æ–ø–∫–∞: "–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]
```

---

## ‚ö†Ô∏è –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –û—Ç—á–µ—Ç –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

**–ü—Ä–æ–≤–µ—Ä—å:**
1. Railway ‚Üí Worker service ‚Üí Logs
   - –ò—â–∏: `Starting CSV analysis {id}`
   - –ò—â–∏: `Full report sent to user {telegram_id}`
2. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –æ—à–∏–±–∫—É `Report not found` ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ë–î
3. –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –æ—à–∏–±–∫—É `Failed to send report` ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ —Å Bot API

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ `BOT_TOKEN` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ Railway
- –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ worker service –∑–∞–ø—É—â–µ–Ω (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ‚úÖ Running)

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Supabase Storage –æ—à–∏–±–∫–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –õ–æ–≥–∏: `Bucket 'csv-files' not found`
- –õ–æ–≥–∏: `Failed to upload CSV to Storage`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –±–∞–∫–µ—Ç `csv-files` —Å–æ–∑–¥–∞–Ω –≤ Supabase
2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ `SUPABASE_KEY` = **service_role** key (–ù–ï anon!)
3. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª–∏—Ç–∏–∫—É (—Å–º. `docs/SUPABASE_POLICY_FIX.md`)

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –í–æ—Ä–∫–µ—Ä –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
- CSV –≤–∏—Å–∏—Ç –≤ —Å—Ç–∞—Ç—É—Å–µ `PROCESSING` > 5 –º–∏–Ω—É—Ç
- –ù–µ—Ç –ª–æ–≥–æ–≤ –≤ Worker service

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å Railway ‚Üí Worker service ‚Üí **Restart**
2. –ü—Ä–æ–≤–µ—Ä—å `REDIS_URL` –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: `Dramatiq broker set successfully`

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**: `docs/TESTING_GUIDE.md`
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Supabase Policy**: `docs/SUPABASE_POLICY_FIX.md`
- **–î–µ—Ç–∞–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è UX**: `docs/UX_RESTORE_SUMMARY.md`
- **Load Test**: `tests/load_test.py`

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞

–¢–µ—Å—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º, –µ—Å–ª–∏:

1. ‚úÖ **Smoke Test –ø—Ä–æ—à–µ–ª** ‚Äî –æ—Ç—á–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. ‚úÖ **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –º–µ–Ω—é** ‚Äî –≤—Å—ë –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–∞–º–æ
3. ‚úÖ **–û—Ç—á–µ—Ç –ø–æ–ª–Ω—ã–π** ‚Äî –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
4. ‚úÖ **–ù–∏–∫–∞–∫–∏—Ö –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤** ‚Äî –≤—Å—ë –∏–∑ LEXICON_RU
5. ‚úÖ **Worker —Ä–∞–±–æ—Ç–∞–µ—Ç** ‚Äî –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
6. ‚úÖ **RAM < 450MB** ‚Äî –ø—Ä–æ–≤–µ—Ä—å Railway Metrics

---

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞** ‚Üí –º–æ–∂–µ—à—å –º–µ—Ä–∂–∏—Ç—å –≤ `main` –∏ –¥–µ–ø–ª–æ–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–Ω! üöÄ

**–î–∞—Ç–∞**: 2024-11-13  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

