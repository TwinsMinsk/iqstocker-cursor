# üéâ –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –û–¢–ß–ï–¢–û–í –ò –ú–ï–ù–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û!

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤** - —Å–∏–º–≤–æ–ª—ã `**` –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–ª–∏—Å—å, —á—Ç–æ –ª–æ–º–∞–ª–æ Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ–Ω—é –ø–æ—Å–ª–µ –æ—Ç—á–µ—Ç–∞** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–≥ –ø–µ—Ä–µ–π—Ç–∏ –∫ –¥—Ä—É–≥–∏–º —Ä–∞–∑–¥–µ–ª–∞–º –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
1. **–ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ñ—É–Ω–∫—Ü–∏—è `escape_markdown()` —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–ª–∞ –≤—Å–µ —Å–∏–º–≤–æ–ª—ã `*`, –≤–∫–ª—é—á–∞—è —Ç–µ, —á—Ç–æ –Ω—É–∂–Ω—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ–Ω—é** - –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞ –Ω–µ –±—ã–ª–æ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

## ‚úÖ –ü–æ–ª–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏—é —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```python
def escape_markdown_preserve_formatting(text: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è Markdown, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."""
    # –°–Ω–∞—á–∞–ª–∞ –∑–∞—â–∏—â–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = text.replace('**', '___BOLD___')
    text = text.replace('*', '___ITALIC___')
    
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–∫—Ä–æ–º–µ _)
    text = (text.replace('-', '\\-')
                .replace('(', '\\(')
                .replace(')', '\\)')
                .replace('.', '\\.')
                .replace('!', '\\!')
                .replace('[', '\\[')
                .replace(']', '\\]')
                .replace('`', '\\`'))
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = text.replace('___BOLD___', '**')
    text = text.replace('___ITALIC___', '*')
    
    return text
```

### 2. –ò—Å–ø—Ä–∞–≤–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫—É –æ—Ç—á–µ—Ç–∞
**–ë—ã–ª–æ:**
```python
await message.answer(escape_markdown(report_text))
```

**–°—Ç–∞–ª–æ:**
```python
await message.answer(escape_markdown_preserve_formatting(report_text))
```

### 3. –î–æ–±–∞–≤–∏–ª–∏ –º–µ–Ω—é –ø–æ—Å–ª–µ –æ—Ç—á–µ—Ç–∞
```python
# Send menu after report
from bot.keyboards.main_menu import get_main_menu_keyboard
from database.models import User

# Get user from database
user = db.query(User).filter(User.telegram_id == message.from_user.id).first()
if user:
    await message.answer(
        "–ß—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–∏–º –¥–∞–ª—å—à–µ?",
        reply_markup=get_main_menu_keyboard(user.subscription_type)
    )
else:
    await message.answer("–ß—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–∏–º –¥–∞–ª—å—à–µ?")
```

## üß™ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤** - –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- ‚úÖ **–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤** - –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ **–ò–º–ø–æ—Ä—Ç –º–µ–Ω—é** - –º–µ–Ω—é —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ **–ù–∞–≤–∏–≥–∞—Ü–∏—è** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –∫ –¥—Ä—É–≥–∏–º —Ä–∞–∑–¥–µ–ª–∞–º

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```
üìä –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤: ‚úÖ OK
ü§ñ –ò–º–ø–æ—Ä—Ç –º–µ–Ω—é: ‚úÖ OK

üéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–®–õ–ò –£–°–ü–ï–®–ù–û!
```

## üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**üî¥ –°–¢–ê–†–û–ï –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–ï (–ª–æ–º–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):**
```
üìä \*\*–û–¢–ß–Å–¢ –ó–ê –ú–ï–°–Ø–¶ –ì–û–¢–û–í\!\*\*
üè¢ \*\*–û–°–ù–û–í–ù–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:\*\*
```

**üü¢ –ù–û–í–û–ï –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–ï (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):**
```
üìä **–û–¢–ß–Å–¢ –ó–ê –ú–ï–°–Ø–¶ –ì–û–¢–û–í\!**
üè¢ **–û–°–ù–û–í–ù–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:**
```

## üöÄ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç
1. **–ó–∞–≥—Ä—É–∑–∫–∞ CSV —Ñ–∞–π–ª–æ–≤** - –±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–∞–π–ª—ã –±–µ–∑ –æ—à–∏–±–æ–∫
2. **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥** - –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ CSV** - —Ñ–∞–π–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** - –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
5. **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–æ–≤** - –æ—Ç—á–µ—Ç—ã —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
6. **–ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–π—Ç–∏ –∫ –¥—Ä—É–≥–∏–º —Ä–∞–∑–¥–µ–ª–∞–º
7. **–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª** - –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `bot/handlers/analytics.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ –º–µ–Ω—é

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:** `python run_local_bot.py`
2. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ CSV —Ñ–∞–π–ª** –±–æ—Ç—É –≤ Telegram
3. **–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º** –±–æ—Ç–∞ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
4. **–í–≤–æ–¥–∏—Ç–µ —á–∏—Å–ª–∞** –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è, –ª–∏–º–∏—Ç–æ–≤ –∏ —Ç.–¥.
5. **–í—ã–±–∏—Ä–∞–π—Ç–µ —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞** –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
6. **–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∏** (1-2 –º–∏–Ω—É—Ç—ã)
7. **–ü–æ–ª—É—á–∏—Ç–µ –æ—Ç—á–µ—Ç** —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
8. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é** –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –¥—Ä—É–≥–∏–º —Ä–∞–∑–¥–µ–ª–∞–º

## üîß –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `test_report_formatting.py` - —Ç–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–æ–≤ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω—é

## üéØ –ò—Ç–æ–≥
**–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç—á–µ—Ç–æ–≤ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –º–µ–Ω—é –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!** –ë–æ—Ç —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç—ã —Å Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞.
