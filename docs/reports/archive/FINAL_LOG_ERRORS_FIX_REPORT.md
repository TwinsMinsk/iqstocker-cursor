# üéâ –í–°–ï –û–®–ò–ë–ö–ò –ò–ó –õ–û–ì–û–í –ò–°–ü–†–ê–í–õ–ï–ù–´!

## ‚ùå –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤ –ª–æ–≥–∞—Ö:

### 1. –û—à–∏–±–∫–∞ –≤ `start.py` —Å—Ç—Ä–æ–∫–∞ 109 (–ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞):
```
TelegramBadRequest: Telegram server says - Bad Request: can't parse entities: Character '(' is reserved and must be escaped with the preceding '\'
```

### 2. –û—à–∏–±–∫–∞ –≤ `analytics.py` —Å—Ç—Ä–æ–∫–∞ 228:
```
TelegramBadRequest: Telegram server says - Bad Request: can't parse entities: Character '+' is reserved and must be escaped with the preceding '\'
```

### 3. –û—à–∏–±–∫–∞ –≤ `start.py` —Å—Ç—Ä–æ–∫–∞ 110 (–≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞):
```
TelegramBadRequest: Telegram server says - Bad Request: can't parse entities: Character '!' is reserved and must be escaped with the preceding '\'
```

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

### 1. –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `escape_markdown` –≤ `start.py`
**–§–∞–π–ª:** `bot/handlers/start.py`
```python
from bot.utils.markdown import escape_markdown
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –≤ `start.py` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
**–ë—ã–ª–æ:**
```python
welcome_text = escape_markdown(f"""üëã *–ü—Ä–∏–≤–µ—Ç\\! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ IQStocker* üìä
...
*–¢–≤–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ:* TEST_PRO \\(–¥–æ {test_pro_expires.strftime('%d.%m.%Y')}\\)
...
""")
```

**–°—Ç–∞–ª–æ:**
```python
# –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç–¥–µ–ª—å–Ω–æ
test_pro_expires_str = escape_markdown(test_pro_expires.strftime('%d.%m.%Y'))
welcome_text = escape_markdown(f"""üëã *–ü—Ä–∏–≤–µ—Ç\\! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ IQStocker* üìä
...
*–¢–≤–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ:* TEST_PRO \\(–¥–æ {test_pro_expires_str}\\)
...
""")
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ f-—Å—Ç—Ä–æ–∫–∞—Ö
**–î–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```python
welcome_text = escape_markdown(f"""üëã *–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {escape_markdown(message.from_user.first_name)}\\!*

–†–∞–¥ —Å–Ω–æ–≤–∞ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å\\!

*–¢–≤–æ–π —Ç–∞—Ä–∏—Ñ:* {escape_markdown(user.subscription_type.value)}
*–°—Ç–∞—Ç—É—Å:* {escape_markdown(status_text)}

–ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è\\? üëá""")
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ `+` –≤ `bot/utils/markdown.py`
**–§–∞–π–ª:** `bot/utils/markdown.py`
```python
def escape_markdown(text: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è Markdown."""
    return (text.replace('*', '\\*')
                .replace('-', '\\-')
                .replace('(', '\\(')
                .replace(')', '\\)')
                .replace('.', '\\.')
                .replace('!', '\\!')
                .replace('_', '\\_')
                .replace('[', '\\[')
                .replace(']', '\\]')
                .replace('`', '\\`')
                .replace('+', '\\+'))  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û

def escape_markdown_preserve_formatting(text: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è Markdown, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."""
    # –°–Ω–∞—á–∞–ª–∞ –∑–∞—â–∏—â–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = text.replace('**', '___BOLD___')
    text = text.replace('*', '___ITALIC___')
    
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–∫—Ä–æ–º–µ _)
    text = (text.replace('-', '\\-')
                .replace('(', '\\(')
                .replace(')', '\\)')
                .replace('.', '\\.')
                .replace('!', '\\!')
                .replace('[', '\\[')
                .replace(']', '\\]')
                .replace('`', '\\`')
                .replace('+', '\\+'))  # ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = text.replace('___BOLD___', '**')
    text = text.replace('___ITALIC___', '*')
    
    return text
```

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

- ‚úÖ **–ò–º–ø–æ—Ä—Ç start.py:** OK
- ‚úÖ **–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:** OK
- ‚úÖ **–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã:** OK
- ‚úÖ **–í—Å–µ —Å–∏–º–≤–æ–ª—ã –≤–∫–ª—é—á–∞—è +:** OK

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

1. `bot/handlers/start.py` - –¥–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
2. `bot/utils/markdown.py` - –¥–æ–±–∞–≤–ª–µ–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ `+`

## üöÄ –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:

1. ‚úÖ **–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω** —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
2. ‚úÖ **–í—Å–µ —Å–∏–º–≤–æ–ª—ã —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã** –≤–∫–ª—é—á–∞—è `+` –∏ `!`
3. ‚úÖ **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ f-—Å—Ç—Ä–æ–∫–∞—Ö** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è
4. ‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã**

## üí° –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:

1. **–ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω** —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏
2. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ /start** –±–æ—Ç—É –≤ Telegram
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –∫–Ω–æ–ø–∫–∏** - –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã
4. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ CSV —Ñ–∞–π–ª** –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
5. **–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏** - –≤—Å–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –æ—à–∏–±–æ–∫

## üéØ –ò—Ç–æ–≥:

**–í–°–ï –û–®–ò–ë–ö–ò –ò–ó –õ–û–ì–û–í –ò–°–ü–†–ê–í–õ–ï–ù–´!**

- ‚úÖ **Character '(' is reserved** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ **Character '+' is reserved** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ  
- ‚úÖ **Character '!' is reserved** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- ‚úÖ **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ f-—Å—Ç—Ä–æ–∫–∞—Ö** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã** - OK

**–ë–æ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω!** üéâ
