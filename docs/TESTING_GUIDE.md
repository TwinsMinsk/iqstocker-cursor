# üß™ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é High-Load –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

## –¶–µ–ª—å
–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞ –¥–ª—è –Ω–∞–≥—Ä—É–∑–∫–∏ 1000-2000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏, –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—è –ø—Ä–æ–¥–∞–∫—à–Ω.

---

## üìã –ß–µ–∫–ª–∏—Å—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏

### 1. Supabase Storage
- [ ] –°–æ–∑–¥–∞–Ω –±–∞–∫–µ—Ç `csv-files` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ (service_role –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)
- [ ] –ü–æ–ª—É—á–µ–Ω `service_role` key –∏–∑ Supabase Dashboard

### 2. Railway —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ environment
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–≤–µ—Ç–∫–∞ `test/high-load-optimization`)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [ ] –ó–∞–ø—É—â–µ–Ω—ã –æ–±–∞ —Å–µ—Ä–≤–∏—Å–∞: bot + worker

### 3. –¢–µ—Å—Ç–æ–≤—ã–π –±–æ—Ç
- [ ] –°–æ–∑–¥–∞–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–æ—Ç —á–µ—Ä–µ–∑ @BotFather –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- [ ] –¢–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω –≤ Railway –∫–∞–∫ `BOT_TOKEN`

---

## üîß –ü–æ—à–∞–≥–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –°–æ–∑–¥–∞–π –≤–µ—Ç–∫—É –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
cd C:\IQStocker-cursor2
git checkout -b test/high-load-optimization
git add .
git commit -m "feat: high-load optimization for 1000-2000 users"
git push origin test/high-load-optimization
```

---

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π Supabase Storage

#### 2.1. –°–æ–∑–¥–∞–π –±–∞–∫–µ—Ç

1. –û—Ç–∫—Ä–æ–π https://supabase.com/dashboard/project/tqydndcvjqigxvjmaacj/storage/buckets
2. –ù–∞–∂–º–∏ **"Create bucket"**
3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - **Name**: `csv-files`
   - **Public bucket**: `No` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π)
   - **File size limit**: 10 MB (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
4. –ù–∞–∂–º–∏ **"Create bucket"**

#### 2.2. –ü–æ–ª—É—á–∏ service_role key

1. –û—Ç–∫—Ä–æ–π https://supabase.com/dashboard/project/tqydndcvjqigxvjmaacj/settings/api
2. –°–∫–æ–ø–∏—Ä—É–π **service_role key** (–ù–ï anon key!)
3. –°–æ—Ö—Ä–∞–Ω–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Railway

#### 2.3. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `service_role` key –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ Storage. –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –ø—Ä–æ–±–ª–µ–º—ã, —Å–æ–∑–¥–∞–π –ø–æ–ª–∏—Ç–∏–∫—É:

1. –û—Ç–∫—Ä–æ–π –±–∞–∫–µ—Ç `csv-files` ‚Üí **Policies**
2. –°–æ–∑–¥–∞–π –Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É:

```sql
-- –î–ª—è service_role (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ—Ç–æ–º)
CREATE POLICY "Service role can manage all files"
ON storage.objects FOR ALL
TO service_role
USING (bucket_id = 'csv-files')
WITH CHECK (bucket_id = 'csv-files');
```

---

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π Railway —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

#### 3.1. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç

**–í–∞—Ä–∏–∞–Ω—Ç A: –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)**
1. –û—Ç–∫—Ä–æ–π https://railway.app/dashboard
2. –ù–∞–∂–º–∏ **"+ New Project"**
3. –í—ã–±–µ—Ä–∏ **"Deploy from GitHub repo"**
4. –í—ã–±–µ—Ä–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `IQStocker-cursor2`
5. –í—ã–±–µ—Ä–∏ –≤–µ—Ç–∫—É `test/high-load-optimization`

**–í–∞—Ä–∏–∞–Ω—Ç B: –ù–æ–≤—ã–π environment –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ø—Ä–æ–µ–∫—Ç–µ**
1. –û—Ç–∫—Ä–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–µ–∫—Ç –≤ Railway
2. –ù–∞–∂–º–∏ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ environment (–≤–≤–µ—Ä—Ö—É —Å–ª–µ–≤–∞)
3. –í—ã–±–µ—Ä–∏ **"+ New Environment"**
4. –ù–∞–∑–≤–∞–Ω–∏–µ: `test-high-load`
5. –ü–æ–¥–∫–ª—é—á–∏ –≤–µ—Ç–∫—É `test/high-load-optimization`

#### 3.2. –ù–∞—Å—Ç—Ä–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í Railway Dashboard ‚Üí Settings ‚Üí Variables, –¥–æ–±–∞–≤—å:

```bash
# === Telegram ===
BOT_TOKEN=<—Ç–æ–∫–µ–Ω_—Ç–µ—Å—Ç–æ–≤–æ–≥–æ_–±–æ—Ç–∞>

# === Supabase Database ===
DATABASE_URL=postgresql://postgres.tqydndcvjqigxvjmaacj:Z7lVqinMIOzDJVSq@aws-0-eu-west-1.pooler.supabase.com:5432/postgres

# === Supabase Storage ===
SUPABASE_URL=https://tqydndcvjqigxvjmaacj.supabase.co
SUPABASE_KEY=<—Ç–≤–æ–π_service_role_key>

# === Database Connection Limits (PRO –ø–ª–∞–Ω) ===
SUPABASE_SESSION_LIMIT=10  # –î–ª—è Hobby Railway (512MB RAM)
# SUPABASE_SESSION_LIMIT=30  # –ï—Å–ª–∏ –∞–ø–≥—Ä–µ–π–¥–∏—à—å Railway –¥–æ Pro

# === File Limits ===
MAX_FILE_SIZE=5242880  # 5MB (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è Hobby)

# === Redis ===
REDIS_URL=<—Ç–≤–æ–π_redis_url>

# === Debug (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ===
DEBUG=True
LOG_LEVEL=INFO
```

#### 3.3. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å–µ—Ä–≤–∏—Å–æ–≤

Railway –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –∏–∑ `railway.json`:

- ‚úÖ **bot** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç (replicas: 1)
- ‚úÖ **web** ‚Äî –∞–¥–º–∏–Ω–∫–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- ‚úÖ **worker** ‚Äî Dramatiq –≤–æ—Ä–∫–µ—Ä (replicas: 1)

–ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ —Å–æ–∑–¥–∞–ª–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Å–æ–∑–¥–∞–π –∏—Ö –≤—Ä—É—á–Ω—É—é:

1. **Bot Service**:
   - Start Command: `python scripts/deployment/start_bot.py`
   - Environment: `SERVICE_TYPE=bot`

2. **Worker Service**:
   - Start Command: `python scripts/deployment/start_worker.py`
   - Environment: `SERVICE_TYPE=worker`

---

### –®–∞–≥ 4: –ó–∞–¥–µ–ø–ª–æ–π –∏ –ø—Ä–æ–≤–µ—Ä—å

#### 4.1. –ó–∞–¥–µ–ø–ª–æ–π —Å–µ—Ä–≤–∏—Å—ã

1. Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–Ω–µ—Ç –¥–µ–ø–ª–æ–π –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
2. –î–æ–∂–¥–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–∏–ª–¥–∞ (–æ–±—ã—á–Ω–æ 3-5 –º–∏–Ω—É—Ç)
3. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –æ–±–æ–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
   - **bot**: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ‚úÖ Running
   - **worker**: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ‚úÖ Running

#### 4.2. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏

**Bot logs** (Railway ‚Üí bot ‚Üí Deployments ‚Üí Logs):
```
INFO - Bot started successfully
INFO - Using Supabase PostgreSQL configuration with NullPool
INFO - Using SUPABASE_SESSION_LIMIT=10 for concurrent async sessions
INFO - Scheduler started
INFO - Resources: RAM=80.5MB CPU=2.3%
```

**Worker logs** (Railway ‚Üí worker ‚Üí Deployments ‚Üí Logs):
```
INFO - Starting Dramatiq worker
INFO - Worker started with 1 process, 2 threads
INFO - Broker: RedisBroker
INFO - Actors: process_csv_analysis_task, notify_analysis_complete, notify_analysis_failed
```

**–ï—Å–ª–∏ –≤–∏–¥–∏—à—å –æ—à–∏–±–∫–∏**, –ø—Ä–æ–≤–µ—Ä—å:
- ‚ùå `ValueError: SUPABASE_URL and SUPABASE_KEY must be set` ‚Üí –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- ‚ùå `Bucket 'csv-files' not found` ‚Üí –Ω–µ —Å–æ–∑–¥–∞–Ω –±–∞–∫–µ—Ç –≤ Supabase
- ‚ùå `Connection to Redis refused` ‚Üí –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω REDIS_URL

---

## üß™ Smoke Test (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)

### 1. –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

–û—Ç–∫—Ä–æ–π Telegram, –Ω–∞–π–¥–∏ —Å–≤–æ–µ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞**:
   ```
   /start
   ```
   –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏**:
   ```
   /analytics
   ```
   –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –º–µ–Ω—é –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

3. **–ó–∞–≥—Ä—É–∑–∫–∞ CSV**:
   - –ó–∞–≥—Ä—É–∑–∏ —Ç–µ—Å—Ç–æ–≤—ã–π CSV —Ñ–∞–π–ª (–∏–∑ `tests/fixtures/test_report.csv`)
   - –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
     - ‚úÖ "–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω"
     - ‚úÖ –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (Shutterstock, Adobe, etc.)
     - ‚úÖ –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞..."

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏**:
   - –ü–æ–¥–æ–∂–¥–∏ 10-30 —Å–µ–∫—É–Ω–¥
   - –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
     - ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω"
     - ‚úÖ –û—Ç—á–µ—Ç —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ Supabase Storage

1. –û—Ç–∫—Ä–æ–π Supabase Dashboard ‚Üí Storage ‚Üí csv-files
2. –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Ñ–∞–π–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ: `<user_id>/<uuid>_<filename>.csv`

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ Resource Monitor

–í –ª–æ–≥–∞—Ö Railway (bot service):
```
INFO - Resources: RAM=120.3MB CPU=5.2%
```

–ï—Å–ª–∏ RAM > 400MB ‚Üí –ø—Ä–æ–≤–µ—Ä—å, –Ω–µ—Ç –ª–∏ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏

---

## üöÄ Load Test (–Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ CSV

–°–æ–∑–¥–∞–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª:

```bash
poetry run python -c "
import asyncio
from tests.load_test import create_test_csv
asyncio.run(create_test_csv())
"
```

### 2. –ù–∞—Å—Ç—Ä–æ–π load_test.py

–û—Ç–∫—Ä–æ–π `tests/load_test.py`, —É—Å—Ç–∞–Ω–æ–≤–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```python
TEST_BOT_TOKEN = "—Ç–æ–∫–µ–Ω_—Ç–≤–æ–µ–≥–æ_—Ç–µ—Å—Ç–æ–≤–æ–≥–æ_–±–æ—Ç–∞"
TEST_CHAT_IDS = [123456789]  # –¢–≤–æ–π Telegram ID
CONCURRENT_USERS = 20  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
```

### 3. –ó–∞–ø—É—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Ç–µ—Å—Ç

```bash
poetry run python tests/load_test.py
```

### 4. –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

**–£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç (Railway Hobby 512MB):**
```
üìä LOAD TEST RESULTS
Total users: 20
Successful: 18 (90.0%)
Failed: 2 (10.0%)
Average time per user: 25.3s
Total test duration: 35.7s
‚úÖ LOAD TEST PASSED! (90%+ success rate)
```

**–ï—Å–ª–∏ —Ç–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω (<90% success rate):**

1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Railway –Ω–∞ OOM Kill:
   ```
   FATAL - Out of memory
   ```
   ‚Üí –£–º–µ–Ω—å—à–∏ `CONCURRENT_USERS` –¥–æ 10-15 –∏–ª–∏ –∞–ø–≥—Ä–µ–π–¥–Ω–∏ Railway –¥–æ Pro

2. –ü—Ä–æ–≤–µ—Ä—å Supabase connection errors:
   ```
   ERROR - MaxClientsInSessionMode
   ```
   ‚Üí –£–≤–µ–ª–∏—á—å `SUPABASE_SESSION_LIMIT` –¥–æ 15

3. –ü—Ä–æ–≤–µ—Ä—å worker queue:
   ```
   WARNING - Worker queue size: 50
   ```
   ‚Üí –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ worker replicas –≤ Railway

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ç–µ—Å—Ç–∞

### Railway Metrics

1. –û—Ç–∫—Ä–æ–π Railway ‚Üí Metrics
2. –°–ª–µ–¥–∏ –∑–∞:
   - **RAM Usage**: –Ω–µ –¥–æ–ª–∂–Ω–∞ –ø—Ä–µ–≤—ã—à–∞—Ç—å 450MB (–∏–∑ 512MB)
   - **CPU Usage**: –¥–æ–ø—É—Å—Ç–∏–º–æ 80-100% –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - **Network**: –ø—Ä–æ–≤–µ—Ä—å –Ω–µ—Ç –ª–∏ –∞–Ω–æ–º–∞–ª–∏–π

### Supabase Dashboard

1. –û—Ç–∫—Ä–æ–π Supabase ‚Üí Database ‚Üí Connection pooling
2. –ü—Ä–æ–≤–µ—Ä—å:
   - **Active connections**: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å < 15 (–∏–∑ 200)
   - **Idle connections**: –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏–º–µ—Ç—å 2-5

### Resource Monitor (–ª–æ–≥–∏)

–ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –≤ –ª–æ–≥–∞—Ö bot service:
```
INFO - Resources: RAM=250.3MB CPU=45.2%
WARNING - HIGH MEMORY: 410.5MB / 512MB  # –ï—Å–ª–∏ RAM > 400MB
```

---

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. Rate Limiting

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ó–∞–≥—Ä—É–∑–∏ 11 —Ñ–∞–π–ª–æ–≤ –ø–æ–¥—Ä—è–¥ –∑–∞ 5 –º–∏–Ω—É—Ç

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –ü–µ—Ä–≤—ã–µ 10 —Ñ–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- ‚úÖ 11-–π —Ñ–∞–π–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º:
  ```
  ‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–≥—Ä—É–∑–æ–∫ (10 —Ñ–∞–π–ª–æ–≤ –≤ —á–∞—Å).
  –ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ —á–∞—Å –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞.
  ```

### 2. File Size Limit

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ó–∞–≥—Ä—É–∑–∏ CSV > 5MB

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –§–∞–π–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏–∑ `LEXICON_RU['file_too_large']`

### 3. Invalid CSV Format

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ó–∞–≥—Ä—É–∑–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π CSV (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–≤–µ—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
- ‚úÖ –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω –∏–∑ `/tmp`
- ‚úÖ –ó–∞–ø–∏—Å—å –≤ –ë–î –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å `FAILED`

### 4. Worker Restart

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ worker service –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ CSV

**–ü—Ä–æ–≤–µ—Ä–∫–∞**:
1. –ó–∞–≥—Ä—É–∑–∏ CSV
2. –ü–æ–∫–∞ –æ–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ worker –≤ Railway
3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∑–∞–¥–∞—á–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (Dramatiq retry)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- ‚úÖ CSV –≤ –∏—Ç–æ–≥–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏)
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

### 5. Graceful Shutdown

**–°—Ü–µ–Ω–∞—Ä–∏–π**: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ bot service

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤**:
```
INFO - Shutting down gracefully...
INFO - Cancelling 3 pending tasks...
INFO - Database engine disposed
INFO - Scheduler stopped
INFO - Bot session closed
INFO - Shutdown complete
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞

–¢–µ—Å—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–º, –µ—Å–ª–∏:

1. ‚úÖ **Smoke Test**: –í—Å–µ 4 –±–∞–∑–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏
2. ‚úÖ **Load Test**: Success rate ‚â• 90% –¥–ª—è 20 concurrent users
3. ‚úÖ **Resource Monitor**: RAM < 450MB –≤ –ø–∏–∫–µ –Ω–∞–≥—Ä—É–∑–∫–∏
4. ‚úÖ **Database**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π < 15 (–∏–∑ 200)
5. ‚úÖ **Rate Limiting**: –ë–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ 10 –∑–∞–≥—Ä—É–∑–æ–∫
6. ‚úÖ **File Cleanup**: –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ `/tmp`
7. ‚úÖ **Error Handling**: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ CSV –Ω–µ –∫—Ä–∞—à–∞—Ç –±–æ—Ç–∞

---

## üö® –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Ç–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω?

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: OOM Kill (RAM > 512MB)

**–°–∏–º–ø—Ç–æ–º—ã**:
- –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –õ–æ–≥–∏: `FATAL - Out of memory`

**–†–µ—à–µ–Ω–∏—è**:
1. –£–º–µ–Ω—å—à–∏ `CONCURRENT_USERS` –≤ load test –¥–æ 10-15
2. –£–º–µ–Ω—å—à–∏ `MAX_FILE_SIZE` –¥–æ 3MB (3145728)
3. –£–º–µ–Ω—å—à–∏ `SUPABASE_SESSION_LIMIT` –¥–æ 5
4. –ê–ø–≥—Ä–µ–π–¥–Ω–∏ Railway –¥–æ Pro (8GB RAM)

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: Database Connection Limit

**–°–∏–º–ø—Ç–æ–º—ã**:
- –õ–æ–≥–∏: `MaxClientsInSessionMode` –∏–ª–∏ `Timeout waiting for connection`
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î

**–†–µ—à–µ–Ω–∏—è**:
1. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å Session Pooler (–ø–æ—Ä—Ç 5432), –∞ –Ω–µ –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
2. –£–≤–µ–ª–∏—á—å `SUPABASE_SESSION_LIMIT` –¥–æ 15-20 (—É —Ç–µ–±—è PRO —Å –ª–∏–º–∏—Ç–æ–º 200)
3. –£–º–µ–Ω—å—à–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ worker replicas

---

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: Worker Queue Overflow

**–°–∏–º–ø—Ç–æ–º—ã**:
- CSV —Ñ–∞–π–ª—ã –≤–∏—Å—è—Ç –≤ —Å—Ç–∞—Ç—É—Å–µ `PENDING` > 5 –º–∏–Ω—É—Ç
- –õ–æ–≥–∏ worker: `Queue size: 100+`

**–†–µ—à–µ–Ω–∏—è**:
1. –£–≤–µ–ª–∏—á—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ worker replicas –≤ Railway (–¥–æ 2-3)
2. –£–≤–µ–ª–∏—á—å threads –≤ `start_worker.py`: `--threads 4`
3. –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ª–∏ Redis

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–æ—Å–æ–º –≤ –ø—Ä–æ–¥–∞–∫—à–Ω

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞:

- [ ] –í—Å–µ 7 –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] Load test –ø—Ä–æ—à–µ–ª —Å 90%+ success rate
- [ ] Resource monitor –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ RAM < 400MB
- [ ] Supabase connections < 15
- [ ] –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Graceful shutdown —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Rate limiting –Ω–∞—Å—Ç—Ä–æ–µ–Ω –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ (10 —Ñ–∞–π–ª–æ–≤/—á–∞—Å)

---

## üîÑ –ü–µ—Ä–µ–Ω–æ—Å –≤ –ø—Ä–æ–¥–∞–∫—à–Ω

### 1. Merge –≤–µ—Ç–∫–∏

```bash
git checkout main
git merge test/high-load-optimization
git push origin main
```

### 2. –û–±–Ω–æ–≤–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ –ø—Ä–æ–¥–∞–∫—à–Ω Railway

```bash
SUPABASE_URL=<—Ç–≤–æ–π_url>
SUPABASE_KEY=<—Ç–≤–æ–π_service_role_key>
SUPABASE_SESSION_LIMIT=10
MAX_FILE_SIZE=5242880
```

### 3. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π rollout

**–í–∞—Ä–∏–∞–Ω—Ç A: Blue-Green Deployment**
1. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π environment –≤ Railway (`production-v2`)
2. –ó–∞–¥–µ–ø–ª–æ–π –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
3. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å —á–∞—Å—Ç—å —Ç—Ä–∞—Ñ–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
4. –ú–æ–Ω–∏—Ç–æ—Ä—å –º–µ—Ç—Ä–∏–∫–∏ 24 —á–∞—Å–∞
5. –ï—Å–ª–∏ –≤—Å—ë –û–ö ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∏ 100% —Ç—Ä–∞—Ñ–∏–∫–∞

**–í–∞—Ä–∏–∞–Ω—Ç B: –ü—Ä—è–º–æ–π –¥–µ–ø–ª–æ–π**
1. –ó–∞–¥–µ–ø–ª–æ–π –≤ —Ç–µ–∫—É—â–∏–π production environment
2. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª–µ–¥–∏ –∑–∞ –ª–æ–≥–∞–º–∏ –∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ø–µ—Ä–≤—ã–µ 2-4 —á–∞—Å–∞
3. –î–µ—Ä–∂–∏ –≥–æ—Ç–æ–≤—ã–π rollback –ø–ª–∞–Ω (–ø—Ä–µ–¥—ã–¥—É—â–∏–π commit)

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Railway (bot + worker)
2. –ü—Ä–æ–≤–µ—Ä—å Supabase Dashboard (Storage + Database connections)
3. –ó–∞–ø—É—Å—Ç–∏ `poetry run python tests/load_test.py` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
4. –ü—Ä–æ–≤–µ—Ä—å Resource Monitor –≤ –ª–æ–≥–∞—Ö

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: 2024-11-13  
**–í–µ—Ä—Å–∏—è**: 1.0  
**Railway Plan**: Hobby (512MB RAM)  
**Supabase Plan**: PRO (200 connections)

