# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ü–µ–ø–æ—á–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è Dramatiq –Ω–∞—Ä—É—à–∏–ª–∞—Å—å –ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏:

1. **–°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å**: –≤–≤–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç—á–µ—Ç –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –≤–∏—Å–µ—Ç—å –≤ —á–∞—Ç–µ
2. **–ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" —Å–æ–∑–¥–∞–≤–∞–ª–∞ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ** –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ
3. **–ù–∞—Ä—É—à–∏–ª–∞—Å—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞**: —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –∑–∞–º–µ–Ω—è—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞, –∞ –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è

### –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ (–¥–æ Dramatiq):
- –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ `safe_edit_message`
- –¶–µ–ø–æ—á–∫–∞ –±—ã–ª–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π: –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–º–µ–Ω—è–ª–æ –¥—Ä—É–≥–æ–µ
- –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é –æ—Ç—á–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

### –ß—Ç–æ —Å–ª–æ–º–∞–ª–æ—Å—å –ø–æ—Å–ª–µ Dramatiq:
- `notify_analysis_complete` –æ—Ç–ø—Ä–∞–≤–ª—è–ª 2 –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è
- `message_ids` –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ –ë–î
- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" —Å–æ–∑–¥–∞–≤–∞–ª–∞ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. `workers/actors.py` ‚Äî `notify_analysis_complete`

**–ë—ã–ª–æ:**
```python
# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö ID
await bot.send_message(chat_id=user_telegram_id, text=intro)
await bot.send_message(chat_id=user_telegram_id, text=report, ...)
```

**–°—Ç–∞–ª–æ:**
```python
# 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
intro_msg = await bot.send_message(...)
message_ids.append(intro_msg.message_id)

report_msg = await bot.send_message(...)
message_ids.append(report_msg.message_id)

# 2. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ë–î –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
csv_analysis.analytics_message_ids = ','.join(map(str, sent_message_ids))
db.commit()
```

### 2. `bot/handlers/analytics.py` ‚Äî `analytics_report_back_callback`

**–ë—ã–ª–æ:**
```python
# –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
for msg_id in message_ids:
    await delete_message_safe(...)

# –°–æ–∑–¥–∞—ë–º –ù–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é
await callback.message.answer(
    text=LEXICON_RU['main_menu_message'],
    reply_markup=get_main_menu_keyboard(...)
)
```

**–°—Ç–∞–ª–æ:**
```python
# –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ö–†–û–ú–ï —Ç–µ–∫—É—â–µ–≥–æ (—Å –∫–Ω–æ–ø–∫–æ–π)
for msg_id in message_ids:
    if msg_id != callback.message.message_id:  # –ù–ï —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ
        await delete_message_safe(...)

# –†–ï–î–ê–ö–¢–ò–†–£–ï–ú —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞)
await safe_edit_message(
    callback=callback,
    text=LEXICON_RU['main_menu_message'],
    reply_markup=get_main_menu_keyboard(...)
)
```

---

## üìä –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### –¶–µ–ø–æ—á–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç—á–µ—Ç–∞:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç CSV
   ‚Üì
2. "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞! –ú—ã —É–≤–µ–¥–æ–º–∏–º —Ç–µ–±—è..."
   ‚Üì
   [—É–¥–∞–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫]
   ‚Üì
3. Dramatiq –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ–∞–π–ª
   ‚Üì
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è 1 —Å–æ–æ–±—â–µ–Ω–∏–µ:
   - [–ü–æ–ª–Ω—ã–π HTML –æ—Ç—á–µ—Ç —Å –∫–Ω–æ–ø–∫–æ–π "üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]
   ‚Üì
5. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ù–∞–∑–∞–¥":
   - –û—Ç—á–µ—Ç –†–ï–î–ê–ö–¢–ò–†–£–ï–¢–°–Ø –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞!)
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏:

‚úÖ **–ß–∏—Å—Ç—ã–π —á–∞—Ç**: –Ω–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π  
‚úÖ **–ü–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è**: —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–º–µ–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞  
‚úÖ **–õ—É—á—à–∏–π UX**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é  

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∏ CSV

1. –û—Ç–∫—Ä–æ–π –±–æ—Ç–∞
2. –ü–µ—Ä–µ–π–¥–∏ –≤ "üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è"
3. –ó–∞–≥—Ä—É–∑–∏ —Ç–µ—Å—Ç–æ–≤—ã–π CSV
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –°–æ–æ–±—â–µ–Ω–∏–µ "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!" —É–¥–∞–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫

### –®–∞–≥ 2: –ü–æ–ª—É—á–∏ –æ—Ç—á–µ—Ç

–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (1-2 –º–∏–Ω—É—Ç—ã):

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ü—Ä–∏—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π HTML –æ—Ç—á–µ—Ç —Å –∫–Ω–æ–ø–∫–æ–π "üè† –ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"

### –®–∞–≥ 3: –ù–∞–∂–º–∏ "–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –û—Ç—á–µ—Ç –ó–ê–ú–ï–ù–Ø–ï–¢–°–Ø –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!)
- ‚úÖ –í —á–∞—Ç–µ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

**–ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- ‚ùå –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –æ—Ç—á–µ—Ç–∞–º–∏
- ‚ùå –î—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –≥–ª–∞–≤–Ω—ã—Ö –º–µ–Ω—é
- ‚ùå –í–≤–æ–¥–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!"

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
- ‚úÖ –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
- ‚úÖ –ß–∏—Å—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

1. **–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ Railway**:
   ```
   Full report sent to user {user_id}
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å –ë–î**:
   ```sql
   SELECT analytics_message_ids FROM csv_analyses WHERE id = {analysis_id};
   ```
   –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `"12345,12346"` (–¥–≤–∞ message_id —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)

3. **–ï—Å–ª–∏ `analytics_message_ids` –ø—É—Å—Ç–æ–π**:
   - –ü—Ä–æ–±–ª–µ–º–∞ –≤ `notify_analysis_complete`
   - –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç message_ids

### –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

1. **–ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥ `analytics_report_back_callback`**:
   - –î–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `safe_edit_message`, –∞ –Ω–µ `callback.message.answer`

2. **–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏**:
   - –ò—â–∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:

- [ ] –ó–∞–≥—Ä—É–∑–∏–ª CSV —Ñ–∞–π–ª
- [ ] –°–æ–æ–±—â–µ–Ω–∏–µ "–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞" —É–¥–∞–ª–∏–ª–æ—Å—å —á–µ—Ä–µ–∑ 3 —Å–µ–∫
- [ ] –ü–æ–ª—É—á–∏–ª –≤–≤–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –æ—Ç—á–µ—Ç
- [ ] –ù–∞–∂–∞–ª "–ù–∞–∑–∞–¥ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
- [ ] –í–≤–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–∏–ª–æ—Å—å
- [ ] –û—Ç—á–µ—Ç –∑–∞–º–µ–Ω–∏–ª—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–Ω–µ —Å–æ–∑–¥–∞–ª–æ—Å—å –Ω–æ–≤–æ–µ!)
- [ ] –í —á–∞—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)
- [ ] –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —á–∏—Å—Ç–∞—è, –Ω–µ—Ç –¥—É–±–ª–µ–π

---

## üéØ –ò—Ç–æ–≥

### –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:

1. ‚úÖ **–£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞**: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (–æ—Ç—á–µ—Ç), –±–µ–∑ –≤–≤–æ–¥–Ω–æ–≥–æ
2. ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ message_id**: Dramatiq worker —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç ID –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
3. ‚úÖ **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞**: –û—Ç—á–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ

### –†–µ–∑—É–ª—å—Ç–∞—Ç:

- ‚úÖ –ß–∏—Å—Ç—ã–π —á–∞—Ç –±–µ–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ü–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (—Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–º–µ–Ω—è—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞)
- ‚úÖ –õ–æ–≥–∏–∫–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `workers/actors.py` (—Å—Ç—Ä–æ–∫–∏ 303-336) ‚Äî —É–±—Ä–∞–Ω–æ –≤–≤–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- `bot/handlers/analytics.py` (—Å—Ç—Ä–æ–∫–∏ 891-914) ‚Äî —É–ø—Ä–æ—â–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 13.11.2025  
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

