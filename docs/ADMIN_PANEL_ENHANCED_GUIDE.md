# IQStocker Admin Panel Enhancement Guide

## Обзор

Этот документ описывает улучшения, внесенные в админ-панель IQStocker. Новая версия включает интерактивный дашборд с аналитикой, быстрые действия для массовых операций, кастомную тему и расширенные возможности управления.

## Новые возможности

### 1. Интерактивный дашборд

#### Доступ
- URL: `http://localhost:5000/admin/dashboard`
- Автоматическое обновление каждые 5 минут
- Адаптивный дизайн для мобильных устройств

#### Метрики
- **Пользователи**: общее количество, активные, новые за 30/7 дней
- **Финансы**: общий доход, MRR, ARPU, конверсия, отток
- **Использование**: CSV анализы, запросы тем, популярные темы
- **Система**: статус БД, активность за час

#### Графики
- **Рост пользователей**: линейный график по месяцам
- **Распределение подписок**: круговая диаграмма
- **Динамика доходов**: столбчатая диаграмма
- **Использование функций**: горизонтальная диаграмма
- **Популярные темы**: топ-10 запрашиваемых тем
- **Активность**: тепловая карта по дням и часам

### 2. Быстрые действия

#### Массовые операции
- **Обновление подписок**: изменение типа подписки для нескольких пользователей
- **Сброс лимитов**: обнуление использованных лимитов
- **Массовые уведомления**: отправка сообщений группе пользователей
- **Удаление анализов**: массовое удаление CSV анализов

#### Экспорт данных
- **Пользователи**: CSV с фильтрацией по подписке, дате, активности
- **Аналитика**: CSV с данными анализов и отчетов
- **Темы**: CSV с популярными темами и статистикой

#### API Endpoints
```
POST /admin/quick-actions/bulk-subscription
POST /admin/quick-actions/bulk-reset-limits
GET  /admin/quick-actions/export-users
GET  /admin/quick-actions/export-analytics
GET  /admin/quick-actions/export-themes
POST /admin/quick-actions/bulk-notification
POST /admin/quick-actions/bulk-delete-analyses
GET  /admin/quick-actions/user-statistics
```

### 3. Кастомная тема IQStocker

#### Цветовая схема
- **Основной**: #2563eb (синий)
- **Вторичный**: #7c3aed (фиолетовый)
- **Успех**: #10b981 (зеленый)
- **Опасность**: #ef4444 (красный)
- **Предупреждение**: #f59e0b (оранжевый)
- **Информация**: #06b6d4 (голубой)

#### Особенности
- Градиентные карточки метрик
- Анимации при наведении
- Темная тема (автоматически)
- Адаптивный дизайн
- Печатные стили

### 4. Расширенная аналитика

#### AnalyticsEngine
- Автоматический расчет метрик
- Кэширование результатов
- Обработка ошибок
- Оптимизированные запросы

#### ChartGenerator
- Интерактивные графики Plotly
- Кастомные цвета бренда
- Адаптивные размеры
- Обработка пустых данных

## Установка и запуск

### 1. Установка зависимостей

```bash
pip install plotly==5.18.0 pandas-profiling==3.6.6 python-multipart==0.0.6 jinja2==3.1.3 itsdangerous==2.1.2
```

### 2. Запуск админ-панели

```bash
python run_admin_fastapi.py
```

### 3. Доступ к интерфейсу

- **Админ-панель**: http://localhost:5000/admin
- **Дашборд**: http://localhost:5000/admin/dashboard
- **API документация**: http://localhost:5000/docs
- **Health check**: http://localhost:5000/health

## Использование

### Дашборд

1. **Просмотр метрик**: основные показатели отображаются в виде карточек
2. **Анализ графиков**: интерактивные графики с возможностью масштабирования
3. **Быстрые действия**: кнопки для перехода к основным разделам
4. **Статус системы**: индикаторы состояния системы

### Быстрые действия

#### Массовое обновление подписок
```json
POST /admin/quick-actions/bulk-subscription
{
    "user_ids": [1, 2, 3],
    "subscription_type": "PRO",
    "duration_days": 30
}
```

#### Экспорт пользователей
```
GET /admin/quick-actions/export-users?subscription_type=PRO&is_active=true
```

#### Массовые уведомления
```json
POST /admin/quick-actions/bulk-notification
{
    "user_ids": [1, 2, 3],
    "message": "Новое обновление доступно!",
    "notification_type": "info"
}
```

### Аналитика

#### Получение статистики пользователей
```
GET /admin/quick-actions/user-statistics
```

Ответ:
```json
{
    "success": true,
    "data": {
        "total_users": 150,
        "active_users": 120,
        "new_users_7d": 15,
        "subscription_distribution": {
            "FREE": 80,
            "PRO": 50,
            "ULTRA": 20
        }
    }
}
```

## Структура файлов

```
admin/
├── static/
│   ├── css/
│   │   └── iqstocker-theme.css    # Кастомная тема
│   ├── js/
│   │   └── dashboard.js           # JavaScript для дашборда
│   └── img/
│       └── logo.png               # Логотип IQStocker
├── templates/
│   ├── dashboard.html             # Шаблон дашборда
│   ├── analytics.html             # Шаблон аналитики
│   ├── quick_actions.html          # Шаблон быстрых действий
│   └── audit_log.html             # Шаблон аудита
├── utils/
│   ├── analytics_engine.py        # Движок аналитики
│   ├── chart_generator.py          # Генератор графиков
│   ├── quick_actions.py            # Быстрые действия
│   └── audit_logger.py             # Логгер аудита
└── views/
    ├── financial_analytics.py      # Финансовая аналитика
    └── usage_analytics.py          # Аналитика использования
```

## Тестирование

### Запуск тестов

```bash
python tests/test_admin_panel_enhanced.py
```

### Тестируемые компоненты

1. **Сервер**: проверка запуска и health check
2. **Дашборд**: доступность и корректность отображения
3. **Аналитика**: расчет метрик и генерация графиков
4. **Быстрые действия**: API endpoints и функциональность
5. **Статические файлы**: CSS и JavaScript
6. **Доступ к админке**: аутентификация и авторизация

## Безопасность

### Аутентификация
- Сессионные токены
- Автоматическое истечение сессий
- Логирование входов

### Авторизация
- Проверка прав доступа
- IP whitelist (опционально)
- Аудит действий

### Защита данных
- Валидация входных данных
- Санитизация вывода
- Защита от CSRF

## Производительность

### Оптимизации
- Кэширование метрик
- Оптимизированные SQL запросы
- Ленивая загрузка графиков
- Сжатие статических файлов

### Мониторинг
- Health check endpoint
- Логирование ошибок
- Метрики производительности

## Устранение неполадок

### Частые проблемы

#### 1. Сервер не запускается
```bash
# Проверьте зависимости
pip install -r requirements.txt

# Проверьте порт
netstat -an | grep 5000
```

#### 2. Ошибки базы данных
```bash
# Проверьте подключение
python -c "from config.database import engine; print('DB OK')"

# Проверьте миграции
alembic current
```

#### 3. Графики не отображаются
- Проверьте подключение к интернету (для Plotly CDN)
- Проверьте консоль браузера на ошибки JavaScript
- Убедитесь, что данные передаются корректно

#### 4. Статические файлы не загружаются
- Проверьте путь к папке `admin/static`
- Убедитесь, что файлы существуют
- Проверьте права доступа

### Логи

```bash
# Просмотр логов админ-панели
tail -f logs/admin_panel.log

# Просмотр логов ошибок
grep ERROR logs/admin_panel.log
```

## Разработка

### Добавление новых метрик

1. Обновите `AnalyticsEngine.get_user_metrics()`
2. Добавьте соответствующий график в `ChartGenerator`
3. Обновите шаблон `dashboard.html`
4. Добавьте тесты

### Добавление новых быстрых действий

1. Создайте метод в `QuickActions`
2. Добавьте endpoint в `admin_fastapi.py`
3. Обновите интерфейс (если нужно)
4. Добавьте тесты

### Кастомизация темы

1. Отредактируйте `admin/static/css/iqstocker-theme.css`
2. Обновите CSS переменные в `:root`
3. Добавьте новые компоненты
4. Протестируйте на разных устройствах

## Поддержка

### Контакты
- **Разработчик**: IQStocker Team
- **Версия**: 1.0.0
- **Дата**: Октябрь 2024

### Обновления
- Следите за обновлениями в репозитории
- Проверяйте changelog перед обновлением
- Делайте резервные копии перед изменениями

---

*Этот документ описывает улучшенную админ-панель IQStocker. Для получения дополнительной информации обращайтесь к команде разработки.*
