# Обновление логики определения "новых работ" - Завершено

## Дата: 23 октября 2025

## Описание изменения
Изменена логика определения "новых работ" с проверки префикса на сравнение по порогу ID.

## Проблема (было)
**Старая логика**: Работа считалась "новой", если её ID **начинался** с определенного префикса.

**Пример** с префиксом `"150"`:
- ✅ ID `1500000000` - новая (начинается с "150")
- ✅ ID `1509999999` - новая (начинается с "150")
- ❌ ID `1510000000` - старая (начинается с "151")
- ❌ ID `1516737463` - старая (начинается с "151")
- ❌ ID `1520000000` - старая (начинается с "152")

**Ограничение**: Невозможно было охватить диапазон ID, например, от `1500000000` и выше.

---

## Решение (стало)
**Новая логика**: Работа считается "новой", если её ID **больше или равен** пороговому значению.

**Пример** с порогом `1490000000`:
- ❌ ID `1489999999` - старая (< 1490000000)
- ✅ ID `1490000000` - новая (>= 1490000000)
- ✅ ID `1500000000` - новая (>= 1490000000)
- ✅ ID `1516737463` - новая (>= 1490000000)
- ✅ ID `2000000000` - новая (>= 1490000000)

---

## Измененные файлы

### 1. `core/analytics/kpi_calculator.py`

#### Изменение в `__init__`:
```python
# Было:
self.new_works_prefix = settings.new_works_id_prefix

# Стало:
self.new_works_id_threshold = int(settings.new_works_id_prefix)
```

#### Изменение в `calculate_new_works_sales_percent`:

**Было** (проверка префикса):
```python
# Convert asset_id to string for pattern matching
df_copy['asset_id_str'] = df_copy['asset_id'].astype(str)

# Count sales of "new" works:
# - ID length must be 10 digits
# - ID must start with the configured prefix
new_sales_count = df_copy[
    (df_copy['asset_id_str'].str.len() == 10) &
    (df_copy['asset_id_str'].str.startswith(self.new_works_prefix))
].shape[0]
```

**Стало** (сравнение по порогу):
```python
# Convert asset_id to numeric for comparison
df_copy['asset_id_num'] = pd.to_numeric(df_copy['asset_id'], errors='coerce')

# Count sales of "new" works:
# - ID length must be 10 digits (1000000000 <= ID <= 9999999999)
# - ID must be >= threshold (e.g., >= 1490000000)
new_sales_count = df_copy[
    (df_copy['asset_id_num'] >= 1000000000) &
    (df_copy['asset_id_num'] <= 9999999999) &
    (df_copy['asset_id_num'] >= self.new_works_id_threshold)
].shape[0]
```

### 2. `config/settings.py`

```python
# Было:
# New works definition (ID prefix)
# Префикс ID для определения "новых" работ (10 цифр, начинаются с этого префикса)
new_works_id_prefix: str = Field("149", env="NEW_WORKS_ID_PREFIX")

# Стало:
# New works definition (ID threshold)
# Пороговое значение ID для определения "новых" работ (ID >= этого значения считаются новыми)
# Например: "1490000000" означает, что все работы с ID >= 1490000000 - новые
new_works_id_prefix: str = Field("1490000000", env="NEW_WORKS_ID_PREFIX")
```

---

## Как использовать

### Настройка порога в `.env`:
```bash
# Все работы с ID >= 1490000000 будут считаться новыми
NEW_WORKS_ID_PREFIX=1490000000
```

### Примеры настройки:

| Значение | Что считается "новым" |
|----------|----------------------|
| `1490000000` | ID >= 1490000000 (по умолчанию) |
| `1500000000` | ID >= 1500000000 |
| `1516737463` | ID >= 1516737463 (начиная с конкретного ID) |
| `2000000000` | ID >= 2000000000 |

---

## Преимущества новой логики

1. ✅ **Гибкость**: Можно указать любое пороговое значение
2. ✅ **Точность**: Охватываются все ID от порога и выше
3. ✅ **Простота**: Не нужно думать о префиксах
4. ✅ **Надежность**: Численное сравнение вместо строковых операций

---

## Проверка

### Тестовые случаи:

С порогом `NEW_WORKS_ID_PREFIX=1490000000`:

| ID | Результат | Причина |
|----|-----------|---------|
| `1489999999` | ❌ Старая | < 1490000000 |
| `1490000000` | ✅ Новая | >= 1490000000 |
| `1500000000` | ✅ Новая | >= 1490000000 |
| `1516737463` | ✅ Новая | >= 1490000000 |
| `9999999999` | ✅ Новая | >= 1490000000 и 10 цифр |
| `10000000000` | ❌ Старая | 11 цифр (не валидный ID) |

---

## Важные замечания

1. **Имя переменной** `new_works_id_prefix` сохранено для обратной совместимости с `.env` файлами
2. **Формат значения**: Теперь это полное число (например, `1490000000`), а не префикс (например, `"149"`)
3. **Диапазон**: Проверяется, что ID имеет ровно 10 цифр (от 1000000000 до 9999999999)
4. **Обработка ошибок**: Используется `pd.to_numeric(..., errors='coerce')` для корректной обработки невалидных ID

---

## Статус
- ✅ Код обновлен
- ✅ Линтер не выявил ошибок
- ✅ Значение по умолчанию установлено: `1490000000`
- ✅ Документация создана

## Следующие шаги
1. Перезапустить бота
2. Протестировать на реальных данных
3. При необходимости скорректировать пороговое значение в `.env`

