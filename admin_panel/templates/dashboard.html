{% extends "base.html" %}

{% block title %}Дашборд - IQStocker Admin{% endblock %}

{% block page_title %}
<i class="fas fa-tachometer-alt me-2"></i>Дашборд
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Дашборд</li>
{% endblock %}

{% block content %}
<!-- Статистические карточки -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-label">Всего пользователей</div>
            <div class="stat-number">{{ stats.total_users }}</div>
            <div class="stat-change">
                <i class="fas fa-arrow-up me-1"></i>+{{ stats.new_users_week }} за неделю
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card success">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-label">Активные пользователи</div>
            <div class="stat-number">{{ stats.active_users }}</div>
            <div class="stat-change">За последние 30 дней</div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card info">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-label">Конверсия</div>
            <div class="stat-number">{{ stats.conversion_rate }}%</div>
            <div class="stat-change">Платные подписки</div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="stat-card warning">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-label">Всего аналитик</div>
            <div class="stat-number">{{ stats.total_analyses }}</div>
            <div class="stat-change">{{ stats.total_reports }} отчетов</div>
        </div>
    </div>
</div>

<!-- Метрики конверсии подписок -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Метрики конверсии подписок
                </h5>
                <form method="get" action="/dashboard" class="d-inline-flex align-items-center">
                    <label for="month-select" class="me-2 mb-0">Период:</label>
                    <select name="month" id="month-select" class="form-select form-select-sm" style="width: auto;" onchange="this.form.submit()">
                        {% for month_option in available_months %}
                        <option value="{{ month_option.value }}" {% if (selected_month and selected_month == month_option.value) or (not selected_month and month_option.is_current) %}selected{% endif %}>
                            {{ month_option.display }}
                        </option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Метрика 1: Новые пользователи -->
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="stat-card info">
                            <div class="stat-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="stat-label">Новые пользователи</div>
                            <div class="stat-number">{{ stats.new_users or 0 }}</div>
                            <div class="stat-change">Пришли на TEST_PRO</div>
                        </div>
                    </div>
                    
                    <!-- Метрика 2: TEST_PRO → PRO -->
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="stat-label">TEST_PRO → PRO</div>
                            <div class="stat-number">{{ stats.test_pro_to_pro or 0 }}</div>
                            <div class="stat-change">Оплаченные переходы</div>
                        </div>
                    </div>
                    
                    <!-- Метрика 3: TEST_PRO → ULTRA -->
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="stat-label">TEST_PRO → ULTRA</div>
                            <div class="stat-number">{{ stats.test_pro_to_ultra or 0 }}</div>
                            <div class="stat-change">Оплаченные переходы</div>
                        </div>
                    </div>
                    
                    <!-- Метрика 4: TEST_PRO → FREE -->
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="stat-label">TEST_PRO → FREE</div>
                            <div class="stat-number">{{ stats.test_pro_to_free or 0 }}</div>
                            <div class="stat-change">Переходы на бесплатный</div>
                        </div>
                    </div>
                    
                    <!-- Метрика 5: FREE → Платный тариф -->
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-arrow-circle-up"></i>
                            </div>
                            <div class="stat-label">FREE → Платный</div>
                            <div class="stat-number">{{ stats.free_to_paid or 0 }}</div>
                            <div class="stat-change">PRO или ULTRA</div>
                        </div>
                    </div>
                    
                    <!-- Метрика 6: Отток PRO -->
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="stat-card" style="border-left: 4px solid #dc3545;">
                            <div class="stat-icon" style="color: #dc3545;">
                                <i class="fas fa-user-times"></i>
                            </div>
                            <div class="stat-label">Отток PRO</div>
                            <div class="stat-number">{{ stats.pro_churn_count or 0 }}</div>
                            <div class="stat-change">
                                <span class="text-danger">{{ stats.pro_churn_percent or 0 }}%</span> не продлили
                            </div>
                        </div>
                    </div>
                    
                    <!-- Метрика 7: Отток ULTRA -->
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="stat-card" style="border-left: 4px solid #dc3545;">
                            <div class="stat-icon" style="color: #dc3545;">
                                <i class="fas fa-user-times"></i>
                            </div>
                            <div class="stat-label">Отток ULTRA</div>
                            <div class="stat-number">{{ stats.ultra_churn_count or 0 }}</div>
                            <div class="stat-change">
                                <span class="text-danger">{{ stats.ultra_churn_percent or 0 }}%</span> не продлили
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if stats.month_display %}
                <div class="mt-3 text-muted small">
                    <i class="fas fa-info-circle me-1"></i>
                    Данные за период: <strong>{{ stats.month_display }}</strong>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Таблица последних пользователей -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-clock me-2"></i>Последние зарегистрированные пользователи</h5>
            </div>
            <div class="card-body">
                {% if stats.latest_users %}
                <div class="table-container">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя пользователя</th>
                                <th>Telegram ID</th>
                                <th>Тариф</th>
                                <th>Дата регистрации</th>
                                <th>Последняя активность</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in stats.latest_users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>
                                    {% if user.username %}
                                        {{ user.username }}
                                    {% elif user.first_name %}
                                        {{ user.first_name }} {% if user.last_name %}{{ user.last_name }}{% endif %}
                                    {% else %}
                                        <em>Не указано</em>
                                    {% endif %}
                                </td>
                                <td><code>{{ user.telegram_id }}</code></td>
                                <td>
                                    {% if user.subscription_type == 'FREE' %}
                                        <span class="badge badge-free">FREE</span>
                                    {% elif user.subscription_type == 'PRO' %}
                                        <span class="badge badge-pro">PRO</span>
                                    {% elif user.subscription_type == 'ULTRA' %}
                                        <span class="badge badge-ultra">ULTRA</span>
                                    {% elif user.subscription_type == 'TEST_PRO' %}
                                        <span class="badge badge-test">TEST_PRO</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.created_at.strftime('%d.%m.%Y %H:%M') if user.created_at else 'N/A' }}</td>
                                <td>
                                    {% if user.last_activity_at %}
                                        {{ user.last_activity_at.strftime('%d.%m.%Y %H:%M') }}
                                    {% else %}
                                        <em>Нет данных</em>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center py-4">Нет зарегистрированных пользователей</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
