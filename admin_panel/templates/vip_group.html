{% extends "base.html" %}

{% block title %}VIP Group Whitelist - IQStocker Admin{% endblock %}

{% block page_title %}
<i class="fas fa-crown me-2"></i>VIP Group Whitelist
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">VIP Group</li>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Управление Whitelist
                    <span class="badge bg-primary ms-2">{{ total_count }}</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- CSV Import -->
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-file-csv me-2"></i>Импорт из CSV
                            </div>
                            <div class="card-body">
                                <form id="csvImportForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="csvFile" class="form-label">Выберите CSV файл</label>
                                        <input type="file" class="form-control" id="csvFile" name="file" accept=".csv" required>
                                        <small class="form-text text-muted">
                                            CSV должен содержать колонку "ID" с Telegram ID пользователей
                                        </small>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-upload me-1"></i>Импортировать
                                    </button>
                                </form>
                                <div id="csvImportResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manual Add -->
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <i class="fas fa-user-plus me-2"></i>Добавить вручную
                            </div>
                            <div class="card-body">
                                <form id="manualAddForm">
                                    <div class="mb-3">
                                        <label for="telegramId" class="form-label">Telegram ID *</label>
                                        <input type="number" class="form-control" id="telegramId" name="telegram_id" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="username" class="form-label">Username</label>
                                        <input type="text" class="form-control" id="username" name="username">
                                    </div>
                                    <div class="mb-3">
                                        <label for="firstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="firstName" name="first_name">
                                    </div>
                                    <div class="mb-3">
                                        <label for="note" class="form-label">Примечание</label>
                                        <textarea class="form-control" id="note" name="note" rows="2"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus me-1"></i>Добавить
                                    </button>
                                </form>
                                <div id="manualAddResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Whitelist Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-table me-2"></i>Список пользователей в Whitelist
        </h5>
    </div>
    <div class="card-body">
        {% if whitelist_entries %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Telegram ID</th>
                        <th>Username</th>
                        <th>First Name</th>
                        <th>Примечание</th>
                        <th>Добавлен</th>
                        <th>Кем добавлен</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in whitelist_entries %}
                    <tr>
                        <td><code>{{ entry.telegram_id }}</code></td>
                        <td>{{ entry.username or '-' }}</td>
                        <td>{{ entry.first_name or '-' }}</td>
                        <td>{{ entry.note or '-' }}</td>
                        <td>{{ entry.added_at.strftime('%d.%m.%Y %H:%M') if entry.added_at else '-' }}</td>
                        <td>{{ entry.added_by or '-' }}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="removeUser({{ entry.telegram_id }})">
                                <i class="fas fa-trash me-1"></i>Удалить
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if total_pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if current_page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ current_page - 1 }}">Предыдущая</a>
                </li>
                {% endif %}
                
                {% for page_num in range(1, total_pages + 1) %}
                    {% if page_num == current_page %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% elif page_num <= 3 or page_num > total_pages - 3 or (page_num >= current_page - 1 and page_num <= current_page + 1) %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                    </li>
                    {% elif page_num == 4 or page_num == total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if current_page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ current_page + 1 }}">Следующая</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>Whitelist пуст. Импортируйте CSV файл или добавьте пользователей вручную.
        </div>
        {% endif %}
    </div>
</div>

<!-- VIP Group Members History -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-history me-2"></i>История участников VIP-группы
            <span class="badge bg-success ms-2">{{ members_total_count }}</span>
            <small class="text-muted ms-2">(Вступили: {{ joined_count }})</small>
        </h5>
    </div>
    <div class="card-body">
        {% if member_entries %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Telegram ID</th>
                        <th>Username</th>
                        <th>Имя</th>
                        <th>Тариф</th>
                        <th>Статус</th>
                        <th>Дата вступления</th>
                        <th>Дата выхода</th>
                        <th>Примечание</th>
                    </tr>
                </thead>
                <tbody>
                    {% for member in member_entries %}
                    <tr>
                        <td>{{ member.id }}</td>
                        <td><code>{{ member.telegram_id }}</code></td>
                        <td>{{ member.username or '-' }}</td>
                        <td>{{ member.first_name or '-' }}</td>
                        <td>
                            {% if member.subscription_type %}
                            <span class="badge 
                                {% if member.subscription_type == 'ULTRA' %}bg-warning
                                {% elif member.subscription_type == 'PRO' %}bg-info
                                {% elif member.subscription_type == 'TEST_PRO' %}bg-secondary
                                {% else %}bg-light text-dark{% endif %}">
                                {{ member.subscription_type }}
                            </span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if member.status.value == 'JOINED' %}
                            <span class="badge bg-success">
                                <i class="fas fa-check-circle me-1"></i>Вступил
                            </span>
                            {% elif member.status.value == 'LEFT' %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-sign-out-alt me-1"></i>Вышел
                            </span>
                            {% elif member.status.value == 'REMOVED' %}
                            <span class="badge bg-danger">
                                <i class="fas fa-ban me-1"></i>Удален
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if member.joined_at %}
                            {{ member.joined_at.strftime('%d.%m.%Y %H:%M') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            {% if member.left_at %}
                            {{ member.left_at.strftime('%d.%m.%Y %H:%M') }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <small>{{ member.note or '-' }}</small>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for members -->
        {% if members_total_pages > 1 %}
        <nav aria-label="Members pagination">
            <ul class="pagination justify-content-center">
                {% if members_current_page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="?members_page={{ members_current_page - 1 }}&page={{ current_page }}">Предыдущая</a>
                </li>
                {% endif %}
                
                {% for page_num in range(1, members_total_pages + 1) %}
                    {% if page_num == members_current_page %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% elif page_num <= 3 or page_num > members_total_pages - 3 or (page_num >= members_current_page - 1 and page_num <= members_current_page + 1) %}
                    <li class="page-item">
                        <a class="page-link" href="?members_page={{ page_num }}&page={{ current_page }}">{{ page_num }}</a>
                    </li>
                    {% elif page_num == 4 or page_num == members_total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if members_current_page < members_total_pages %}
                <li class="page-item">
                    <a class="page-link" href="?members_page={{ members_current_page + 1 }}&page={{ current_page }}">Следующая</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>История пуста. Когда пользователи начнут вступать в VIP-группу, здесь появятся записи.
        </div>
        {% endif %}
    </div>
</div>

<script>
// CSV Import
document.getElementById('csvImportForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData();
    const fileInput = document.getElementById('csvFile');
    const resultDiv = document.getElementById('csvImportResult');
    
    if (!fileInput.files[0]) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Выберите файл</div>';
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    
    resultDiv.innerHTML = '<div class="alert alert-info">Импорт в процессе...</div>';
    
    try {
        const response = await fetch('/vip-group/import-csv', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>Успешно!</strong><br>
                    Добавлено: ${data.added}<br>
                    Пропущено: ${data.skipped}
                    ${data.errors && data.errors.length > 0 ? '<br><small>Ошибки: ' + data.errors.join(', ') + '</small>' : ''}
                </div>
            `;
            fileInput.value = '';
            setTimeout(() => location.reload(), 2000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.message || 'Ошибка при импорте'}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
    }
});

// Manual Add
document.getElementById('manualAddForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resultDiv = document.getElementById('manualAddResult');
    
    resultDiv.innerHTML = '<div class="alert alert-info">Добавление...</div>';
    
    try {
        const response = await fetch('/vip-group/add', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            this.reset();
            setTimeout(() => location.reload(), 1500);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.message || 'Ошибка'}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
    }
});

// Remove User
async function removeUser(telegramId) {
    if (!confirm(`Удалить пользователя ${telegramId} из whitelist?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/vip-group/${telegramId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message || 'Ошибка при удалении');
        }
    } catch (error) {
        alert('Ошибка: ' + error.message);
    }
}
</script>
{% endblock %}

