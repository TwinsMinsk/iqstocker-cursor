# üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ª–∏–º–∏—Ç–æ–≤ –∏ cooldown —Ç–µ–º - –ó–ê–í–ï–†–®–ï–ù–û

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–ø–∏—Å–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ç–µ–º** ‚úÖ
**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–∏–º–∏—Ç—ã —Ç–µ–º –Ω–µ —Å–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–º —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–º—ã".

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏ `Limits` –≤ `bot/handlers/themes.py`
- –í —Ñ—É–Ω–∫—Ü–∏–∏ `generate_themes_callback` –¥–æ–±–∞–≤–ª–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤:
  ```python
  # –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç—ã —Ç–µ–º
  limits_query = select(Limits).where(Limits.user_id == user.id)
  limits_result = await session.execute(limits_query)
  user_limits = limits_result.scalar_one_or_none()
  
  if user_limits:
      user_limits.themes_used += 1
      user_limits.last_theme_request_at = datetime.utcnow()
      session.add(user_limits)
  
  await session.commit()
  ```

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `bot/handlers/themes.py` (—Å—Ç—Ä–æ–∫–∏ 194-206)

---

### 2. **–ü—Ä–æ–≤–µ—Ä–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç cooldown (1 —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é)** ‚úÖ
**–°—Ç–∞—Ç—É—Å:** Cooldown –¥–ª—è —Ç–µ–º —É–∂–µ –±—ã–ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Cooldown –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
  1. –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–∞–∑–¥–µ–ª–∞ "–¢–µ–º—ã" (`themes_callback`)
  2. –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–º—ã" (`generate_themes_callback`)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è `get_theme_cooldown_days_sync()` –∏–∑ `core/theme_settings.py`
- Cooldown –±–µ—Ä–µ—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `llm_settings` (–ø–æ–ª–µ `theme_request_interval_days`)

---

### 3. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ cooldown –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** ‚úÖ
**–ù–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:** –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å cooldown —Ç–µ–º –≤ –¥–Ω—è—Ö, —á–∞—Å–∞—Ö –∏ –º–∏–Ω—É—Ç–∞—Ö —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**

#### A. –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤ –º–æ–¥–µ–ª–∏ `LLMSettings`:
```python
# database/models/llm_settings.py
theme_cooldown_minutes: Mapped[int] = mapped_column(Integer, server_default="10080", nullable=True)
# 7 days = 10080 minutes
```

#### B. –ù–æ–≤—ã–π –∞–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `LLMSettingsAdmin`:
```python
# scripts/runners/admin_fastapi.py
class LLMSettingsAdmin(ModelView, model=LLMSettings):
    column_list = [
        LLMSettings.id, LLMSettings.provider_name, LLMSettings.model_name,
        LLMSettings.is_active, LLMSettings.theme_cooldown_minutes, LLMSettings.requests_count,
        LLMSettings.last_used_at, LLMSettings.created_at
    ]
    
    # Custom formatters
    column_formatters = {
        LLMSettings.theme_cooldown_minutes: lambda m, a: f"{m.theme_cooldown_minutes} –º–∏–Ω ({m.theme_cooldown_minutes // 1440}–¥ {(m.theme_cooldown_minutes % 1440) // 60}—á {m.theme_cooldown_minutes % 60}–º)" if m.theme_cooldown_minutes else "7 –¥–Ω–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
    }
```

#### C. –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è cooldown:
```python
# core/theme_settings.py
def get_theme_cooldown_days_sync() -> int:
    """Get theme cooldown days from database (sync version)."""
    db = SessionLocal()
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å cooldown –≤ –º–∏–Ω—É—Ç–∞—Ö (–Ω–æ–≤–æ–µ –ø–æ–ª–µ)
        result = db.query(LLMSettings.theme_cooldown_minutes).filter(
            LLMSettings.is_active == True
        ).first()
        
        if result and result[0]:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–∏–Ω—É—Ç—ã –≤ –¥–Ω–∏
            return result[0] // 1440  # 1440 –º–∏–Ω—É—Ç = 1 –¥–µ–Ω—å
        
        # Fallback –Ω–∞ —Å—Ç–∞—Ä–æ–µ –ø–æ–ª–µ
        result_days = db.query(LLMSettings.theme_request_interval_days).filter(
            LLMSettings.is_active == True
        ).first()
        return result_days[0] if result_days else 7
    finally:
        db.close()
```

**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: `http://localhost:5000/admin`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª **LLM Settings**
3. –ù–∞–π–¥–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—É—é –∑–∞–ø–∏—Å—å (`is_active = True`)
4. –ò–∑–º–µ–Ω–∏—Ç–µ –ø–æ–ª–µ `theme_cooldown_minutes`:
   - **1 –¥–µ–Ω—å** = 1440 –º–∏–Ω—É—Ç
   - **1 —á–∞—Å** = 60 –º–∏–Ω—É—Ç
   - **7 –¥–Ω–µ–π** (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) = 10080 –º–∏–Ω—É—Ç
   - **30 –º–∏–Ω—É—Ç** = 30 –º–∏–Ω—É—Ç (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `database/models/llm_settings.py` (—Å—Ç—Ä–æ–∫–∏ 37-39)
- `scripts/runners/admin_fastapi.py` (—Å—Ç—Ä–æ–∫–∏ 418-441, 457)
- `core/theme_settings.py` (—Å—Ç—Ä–æ–∫–∏ 35-54)

---

### 4. **–î–æ–±–∞–≤–ª–µ–Ω—ã telegram_id –∏ username –≤ —Ç–∞–±–ª–∏—Ü—É Limits** ‚úÖ
**–ù–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:** –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ Limits —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è telegram_id –∏ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

**–ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
# scripts/runners/admin_fastapi.py
class LimitsAdmin(ModelView, model=Limits):
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è telegram_id –∏ username
    column_formatters = {
        Limits.user_id: lambda m, a: f"{m.user_id} (TG: {m.user.telegram_id}, @{m.user.username})" if m.user else str(m.user_id)
    }
```

**–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç:**
```
user_id: 1 (TG: 811079407, @oleg_smirniy)
user_id: 2 (TG: 441882529, @buttlenny)
```

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:**
- `scripts/runners/admin_fastapi.py` (—Å—Ç—Ä–æ–∫–∏ 199-202)

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ –∏–∑–º–µ–Ω–µ–Ω—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------------|----------|
| `bot/handlers/themes.py` | 194-206 | –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–ø–∏—Å–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ç–µ–º |
| `database/models/llm_settings.py` | 37-39 | –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `theme_cooldown_minutes` |
| `core/theme_settings.py` | 35-54 | –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è cooldown |
| `scripts/runners/admin_fastapi.py` | 199-202, 418-441, 457 | –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã –∏ –∞–¥–º–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å |

**–í—Å–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–æ:** 4 —Ñ–∞–π–ª–∞  
**–í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:** ~50 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

---

## üöÄ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ —Ç–µ–º:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
python start_bot.py

# –í Telegram:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–¢–µ–º—ã"
3. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–º—ã"
4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ü—Ä–æ—Ñ–∏–ª—å"
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ª–∏–º–∏—Ç —Ç–µ–º —É–º–µ–Ω—å—à–∏–ª—Å—è
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ cooldown:
```bash
# –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:5000/admin
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "LLM Settings"
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ theme_cooldown_minutes = 30 (30 –º–∏–Ω—É—Ç –¥–ª—è —Ç–µ—Å—Ç–∞)
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

# –í Telegram:
1. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ–º—ã
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–º—ã —Å–Ω–æ–≤–∞
3. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ cooldown
4. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 –º–∏–Ω—É—Ç
5. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ - –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è telegram_id:
```bash
# –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:5000/admin
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Limits"
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –∫–æ–ª–æ–Ω–∫–µ user_id –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è:
   "1 (TG: 811079407, @oleg_smirniy)"
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è `theme_cooldown_minutes`:

```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "Add theme_cooldown_minutes to llm_settings"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head
```

### –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
- `theme_cooldown_minutes` = 10080 (7 –¥–Ω–µ–π)
- –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `theme_request_interval_days` (7 –¥–Ω–µ–π)

### –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏:
- **1 –º–∏–Ω—É—Ç–∞** = 1
- **1 —á–∞—Å** = 60 –º–∏–Ω—É—Ç
- **1 –¥–µ–Ω—å** = 1440 –º–∏–Ω—É—Ç
- **1 –Ω–µ–¥–µ–ª—è** = 10080 –º–∏–Ω—É—Ç
- **1 –º–µ—Å—è—Ü (30 –¥–Ω–µ–π)** = 43200 –º–∏–Ω—É—Ç

---

## üéØ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!

‚úÖ –°–ø–∏—Å–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ —Ç–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ Cooldown —Ç–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç  
‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cooldown –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏  
‚úÖ telegram_id –∏ username –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ Limits  

**–°–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤ –∏ cooldown –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üöÄ

