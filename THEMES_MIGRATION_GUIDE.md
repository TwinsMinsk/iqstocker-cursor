# Инструкция по миграции базы тем в Supabase

## Проблема
После миграции на Supabase раздел "Получить темы" не работает, так как таблица `theme_requests` пустая.

## Решение
Создан скрипт `scripts/data/import_themes_to_supabase.py` для одноразовой миграции тем из файла `themes_processed.csv` в базу данных Supabase.

## Что было сделано

### 1. Обновлена модель ThemeRequest
- Добавлены поля: `theme_name`, `status`, `created_at`, `updated_at`
- Удалены устаревшие поля: `themes` (JSON), `requested_at`

### 2. Обновлен обработчик тем
- Изменена логика получения тем: теперь берется из `ThemeRequest` со статусом "READY"
- Обновлена логика архива тем
- Исправлена проверка кулдауна

### 3. Создан скрипт миграции
- Читает темы из файла `themes_processed.csv` (2044 темы)
- Импортирует их в таблицу `theme_requests` со статусом "READY"
- Привязывает темы к первому пользователю (админу) в базе

### 4. Создан скрипт проверки
- `scripts/data/verify_themes_migration.py` - проверяет успешность миграции

## Запуск миграции

### Предварительные требования
1. Активировать виртуальное окружение:
   ```bash
   # Windows
   venv\Scripts\activate
   
   # Linux/Mac
   source venv/bin/activate
   ```

2. Убедиться, что в базе данных есть хотя бы один пользователь (админ)

3. Убедиться, что файл `themes_processed.csv` существует в корне проекта

### Запуск миграции
```bash
python scripts/data/import_themes_to_supabase.py
```

### Проверка миграции
```bash
python scripts/data/verify_themes_migration.py
```

### Ожидаемый результат
- Скрипт прочитает 2044 темы из `themes_processed.csv`
- Импортирует их в таблицу `theme_requests` со статусом "READY"
- Покажет статистику импорта
- После этого раздел "Получить темы" должен заработать

## Проверка результата
1. Запустить бота: `python start_bot.py`
2. Отправить команду `/start`
3. Выбрать "Темы и тренды"
4. Нажать "Получить темы"
5. Должны прийти случайные темы из импортированной базы

## Структура данных
- **READY**: темы готовы к выдаче пользователям (2044 темы из CSV)
- **ISSUED**: темы, которые уже были выданы конкретному пользователю
- **PENDING**: темы в процессе обработки (не используется в текущей логике)

## Файлы базы тем
- **Источник**: `themes_processed.csv` (2044 темы)
- **Назначение**: таблица `theme_requests` в Supabase
- **Статус**: READY (готовы к выдаче)
