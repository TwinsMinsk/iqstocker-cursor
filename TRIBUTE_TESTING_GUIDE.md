# üß™ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Tribute

## –°–ø–æ—Å–æ–±—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç—ã

### –°–ø–æ—Å–æ–± 1: –¢–µ—Å—Ç–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:**
   ```
   https://web-production-84a0.up.railway.app/payment-test
   ```

2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**
   - –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ Telegram ID
   - –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ (PRO –∏–ª–∏ ULTRA)
   - –£–∫–∞–∂–∏—Ç–µ —Å—É–º–º—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 990‚ÇΩ)
   - –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π webhook"

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–¥–µ–ª "–ü–ª–∞—Ç–µ–∂–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏" - –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–∏–ª—Å—è `subscription_type` –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `subscription_expires_at`

### –°–ø–æ—Å–æ–± 2: –ü—Ä—è–º–æ–π API –≤—ã–∑–æ–≤

**–ß–µ—Ä–µ–∑ curl:**
```bash
curl -X POST https://web-production-84a0.up.railway.app/webhook/tribute/test \
  -F "telegram_user_id=123456789" \
  -F "subscription_type=PRO" \
  -F "amount=990" \
  -F "payment_id=test_payment_123"
```

**–ß–µ—Ä–µ–∑ Python:**
```python
import requests

response = requests.post(
    "https://web-production-84a0.up.railway.app/webhook/tribute/test",
    data={
        "telegram_user_id": 123456789,  # –í–∞—à Telegram ID
        "subscription_type": "PRO",      # –∏–ª–∏ "ULTRA"
        "amount": 990.0,
        "payment_id": "test_payment_123"  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    }
)

print(response.json())
```

### –°–ø–æ—Å–æ–± 3: –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ webhook (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∏:

```python
import requests
import hmac
import hashlib
import json
from datetime import datetime

# –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞
telegram_user_id = 123456789
subscription_type = "PRO"
payment_id = f"test_{datetime.utcnow().timestamp()}"

# –§–æ—Ä–º–∏—Ä—É–µ–º payload –∫–∞–∫ –æ—Ç Tribute
payload = {
    "name": "new_subscription",
    "id": payment_id,
    "timestamp": datetime.utcnow().isoformat(),
    "payload": {
        "telegram_user_id": telegram_user_id,
        "amount": 99000,  # –í –∫–æ–ø–µ–π–∫–∞—Ö (990‚ÇΩ)
        "subscription_id": payment_id,
        "subscription_name": f"TEST {subscription_type}",
        "product_name": f"TEST {subscription_type} Subscription"
    }
}

payload_str = json.dumps(payload, sort_keys=True)

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å (–µ—Å–ª–∏ API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
api_key = "your_tribute_api_key"  # –ò–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
signature = hmac.new(
    api_key.encode(),
    payload_str.encode(),
    hashlib.sha256
).hexdigest()

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
response = requests.post(
    "https://web-production-84a0.up.railway.app/webhook/tribute",
    data=payload_str,
    headers={
        "Content-Type": "application/json",
        "trbt-signature": signature
    }
)

print(f"Status: {response.status_code}")
print(f"Response: {response.json()}")
```

## ‚úÖ –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:

### 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook
- ‚úì Webhook –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º
- ‚úì –ü–æ–¥–ø–∏—Å—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è (–µ—Å–ª–∏ API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
- ‚úì Payload –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç—Å—è

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
- ‚úì –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `PaymentHandler.process_payment_success()`
- ‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –ø–æ `telegram_id`
- ‚úì –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è (PRO/ULTRA)

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úì –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `subscriptions`
- ‚úì –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `User.subscription_type`
- ‚úì –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `User.subscription_expires_at` (—á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π)
- ‚úì –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ª–∏–º–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`Limits`)

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ü–ª–∞—Ç–µ–∂–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
2. –ù–∞–π–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂ —Å `payment_id` –Ω–∞—á–∏–Ω–∞—é—â–∏–º—Å—è –Ω–∞ "test_"
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
   - –¢–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É
   - –°—É–º–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
   - –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```python
from config.database import SessionLocal
from database.models import User

db = SessionLocal()
user = db.query(User).filter(User.telegram_id == YOUR_TELEGRAM_ID).first()

print(f"Subscription Type: {user.subscription_type}")
print(f"Expires At: {user.subscription_expires_at}")
print(f"Limits - Analytics: {user.limits.analytics_total if user.limits else 'N/A'}")
db.close()
```

## üîç –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- –õ–æ–≥–∏ Railway –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ `web`
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞ payload
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ `PAYMENT_TRIBUTE_API_KEY` (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏)

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `telegram_user_id`
- –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (—Ä–∞–∑–¥–µ–ª "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏")

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
- –õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å "PRO" –∏–ª–∏ "ULTRA")
- –û—à–∏–±–∫–∏ –≤ `PaymentHandler.process_payment_success()`

## üìù –ü—Ä–∏–º–µ—Ä—ã payload –æ—Ç Tribute

### –î–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ PRO:
```json
{
  "name": "new_subscription",
  "id": "sub_1234567890",
  "timestamp": "2025-01-15T10:30:00Z",
  "payload": {
    "telegram_user_id": 123456789,
    "amount": 99000,
    "subscription_id": "sub_1234567890",
    "subscription_name": "IQStocker PRO Subscription",
    "product_name": "PRO Monthly"
  }
}
```

### –î–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ ULTRA:
```json
{
  "name": "new_subscription",
  "id": "sub_0987654321",
  "timestamp": "2025-01-15T10:30:00Z",
  "payload": {
    "telegram_user_id": 123456789,
    "amount": 199000,
    "subscription_id": "sub_0987654321",
    "subscription_name": "IQStocker ULTRA Subscription",
    "product_name": "ULTRA Monthly"
  }
}
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:**
   - –ù–∞–π–¥–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–æ—Ç–µ
   - –ó–∞–ø–æ–º–Ω–∏—Ç–µ –µ–≥–æ Telegram ID
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å FREE –∏–ª–∏ TEST_PRO)

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PRO:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ `/payment-test` –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
   - –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ç–∏–ø PRO
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π webhook
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "–ü–ª–∞—Ç–µ–∂–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏"
   - –ù–∞–π–¥–∏—Ç–µ –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "test_"
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–∏–ª—Å—è —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π)

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ULTRA:**
   - –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å —Å —Ç–∏–ø–æ–º ULTRA
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

5. **–û—á–∏—Å—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
   - –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ FREE
   - –ò–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ç–µ—Å—Ç–æ–≤

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

- –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –∏–º–µ—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å "test_" –≤ `payment_id`
- –¢–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–∞–∫ –∂–µ, –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–µ, –Ω–æ –Ω–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç –¥–µ–Ω—å–≥–∏
- –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ—Å—Ç–æ–≤—ã–π endpoint –∑–∞—â–∏—â–µ–Ω –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)

