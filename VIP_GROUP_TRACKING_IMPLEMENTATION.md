пш# Реализация отслеживания пользователей VIP-группы

## Обзор

Реализована система отслеживания вступлений и выходов пользователей из VIP-группы Telegram. Система автоматически фиксирует:
- Вступление пользователей в группу
- Выход пользователей из группы (добровольный или принудительный)
- Тариф пользователя на момент вступления/выхода
- Историю всех событий для каждого пользователя

## Компоненты системы

### 1. База данных

#### Таблица: `vip_group_members`
Хранит историю всех вступлений и выходов пользователей.

**Поля:**
- `id` - уникальный идентификатор записи
- `telegram_id` - Telegram ID пользователя
- `username` - имя пользователя в Telegram
- `first_name` - имя пользователя
- `subscription_type` - тариф на момент события (FREE, PRO, ULTRA, TEST_PRO)
- `status` - статус события:
  - `JOINED` - пользователь вступил
  - `LEFT` - пользователь вышел добровольно
  - `REMOVED` - пользователь был удален ботом
- `joined_at` - дата вступления
- `left_at` - дата выхода/удаления
- `created_at` - дата создания записи
- `note` - примечание (например, причина удаления)
- `user_id` - связь с таблицей users (опционально)

**Индексы:**
- По telegram_id и status (для быстрого поиска)
- По joined_at (для сортировки по дате вступления)
- По created_at (для сортировки по дате создания записи)

### 2. Модель данных

**Файл:** `database/models/vip_group_member.py`

```python
class VIPGroupMemberStatus(str, Enum):
    JOINED = "JOINED"    # Вступил
    LEFT = "LEFT"        # Вышел
    REMOVED = "REMOVED"  # Удален
```

### 3. Бизнес-логика

**Файл:** `core/vip_group/vip_group_service.py`

**Методы:**

#### `record_member_join(telegram_id, session, username=None, first_name=None)`
Записывает событие вступления пользователя в группу.
- Получает информацию о пользователе из БД
- Фиксирует текущий тариф
- Создает запись с status=JOINED

#### `record_member_leave(telegram_id, session, status=LEFT, note=None)`
Записывает событие выхода/удаления пользователя.
- Получает информацию о пользователе из БД
- Фиксирует текущий тариф
- Создает запись с указанным статусом

#### `get_member_history(telegram_id, session)`
Получает историю всех событий для конкретного пользователя.

### 4. Обработчики бота

**Файл:** `bot/handlers/vip_group.py`

**Обработчик:** `handle_vip_group_member_update(event, session)`

Автоматически отслеживает изменения участников VIP-группы:

1. **При вступлении:**
   - Проверяет доступ пользователя (тариф или whitelist)
   - Если доступ есть → записывает вступление
   - Если доступа нет → удаляет из группы и записывает удаление

2. **При выходе/удалении:**
   - Записывает событие с соответствующим статусом

### 5. Админ-панель

**Файл:** `admin_panel/views/vip_group.py`

**Эндпойнты:**

#### `GET /vip-group`
Главная страница управления VIP-группой.
- Отображает whitelist (кто может вступать)
- Отображает историю вступлений/выходов
- Показывает статистику

#### `GET /api/vip-group/member/{telegram_id}`
API для получения детальной истории конкретного пользователя.

**Шаблон:** `admin_panel/templates/vip_group.html`

Две таблицы:
1. **Whitelist** - пользователи с прямым доступом
2. **История участников** - все события вступлений/выходов

### 6. Миграция БД

**Файл:** `database/migrations/versions/vip_group_members_table.py`

**Revision ID:** `vip_group_members_001`

Создает таблицу `vip_group_members` и необходимые индексы.

## Использование

### Просмотр истории в админ-панели

1. Перейдите в раздел **VIP Group** (`/vip-group`)
2. Прокрутите вниз до раздела "История участников VIP-группы"
3. Здесь отображаются:
   - Telegram ID
   - Username
   - Имя
   - Тариф на момент события
   - Статус (Вступил/Вышел/Удален)
   - Дата вступления
   - Дата выхода
   - Примечание

### Как работает автоматическое отслеживание

1. **Бот добавлен в VIP-группу** как администратор с правами управления участниками
2. **При вступлении пользователя:**
   - Бот получает событие `ChatMemberUpdated`
   - Проверяет, есть ли у пользователя доступ (активный тариф или whitelist)
   - Если есть → записывает в БД со статусом JOINED
   - Если нет → удаляет из группы и записывает со статусом REMOVED

3. **При выходе пользователя:**
   - Бот получает событие `ChatMemberUpdated`
   - Записывает в БД со статусом LEFT или REMOVED

### Повторные входы

Система поддерживает повторные входы:
- Каждое вступление создает новую запись
- При повторной оплате и вступлении → новая запись со свежим тарифом
- История не перезаписывается, а дополняется

## Настройки

В файле `config/settings.py`:
- `vip_group_id` - ID VIP-группы Telegram
- `vip_group_check_enabled` - включить/выключить проверку доступа

## Примеры запросов

### Получить историю пользователя через API

```bash
GET /api/vip-group/member/123456789
```

**Ответ:**
```json
{
  "telegram_id": 123456789,
  "username": "user123",
  "first_name": "Иван",
  "current_subscription": "PRO",
  "history": [
    {
      "id": 1,
      "status": "JOINED",
      "subscription_type": "PRO",
      "joined_at": "2025-01-28 14:30:00",
      "left_at": null,
      "created_at": "2025-01-28 14:30:00",
      "note": null
    }
  ]
}
```

## Тестирование

1. Добавьте пользователя в whitelist через админ-панель
2. Отправьте пользователю ссылку на VIP-группу
3. Пользователь вступает в группу
4. Проверьте в админ-панели → появится запись со статусом JOINED
5. Пользователь выходит из группы
6. Проверьте в админ-панели → появится запись со статусом LEFT

## Диагностика

### Логи

Все события логируются в `logger` с уровнем INFO:
- "User {telegram_id} joined VIP group, checking access..."
- "User {telegram_id} has access, allowing to stay in VIP group"
- "User {telegram_id} doesn't have access, removing from VIP group"
- "Recorded VIP group join for user {telegram_id}"

### Проблемы и решения

**Бот не отслеживает вступления:**
- Проверьте, что бот добавлен в группу как администратор
- Проверьте, что у бота есть права на удаление участников
- Проверьте, что `vip_group_check_enabled=True` в настройках

**Записи не появляются в админ-панели:**
- Проверьте подключение к БД
- Проверьте, что миграция применена (`alembic current`)
- Проверьте логи бота на наличие ошибок

## Безопасность

- Система автоматически удаляет пользователей без доступа
- История не удаляется, только дополняется
- При удалении пользователя из БД (user_id), связь устанавливается в NULL (ON DELETE SET NULL)

## Производительность

- Индексы оптимизированы для быстрого поиска по telegram_id
- Пагинация на 50 записей на страницу
- Асинхронные операции с БД

## Расширение

### Добавить фильтры в админ-панели

В `admin_panel/views/vip_group.py` можно добавить фильтры:
- По статусу (JOINED/LEFT/REMOVED)
- По тарифу
- По дате

### Экспорт истории

Можно добавить эндпойнт для экспорта в CSV:
```python
@router.get("/vip-group/export-members")
async def export_members():
    # Получить все записи
    # Сформировать CSV
    # Вернуть файл
```

## Заключение

Система полностью автоматизирована и не требует ручного вмешательства. Все события отслеживаются автоматически, история сохраняется в БД и доступна для просмотра в админ-панели.

