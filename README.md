# IQStocker Bot

Telegram-бот для аналитики портфолио авторов на стоковых площадках.

## Описание

IQStocker — это Telegram-бот, предназначенный для авторов на стоковых площадках (например, Adobe Stock). Бот предоставляет инструменты для анализа портфеля, генерации тем для съемок, отслеживания трендов и образовательные материалы для увеличения продаж.

## Основные функции

- **Аналитика портфеля:** Анализ CSV-файлов с продажами, определение новых работ по ID (начинаются на 150), предоставление ключевых показателей и рекомендаций
- **Темы для генераций/съемки:** Еженедельная подборка тем на основе актуальных трендов рынка и персональных тем на основе продаж пользователя
- **Топ тем по продажам и доходу:** Подборка тем, показавших лучшие результаты в портфолио пользователя за выбранный период на основе анализа CSV
- **Видеоуроки:** Доступ к базе видеоуроков и других полезных материалов по стокам
- **Календарь стокера:** Ежемесячные подсказки с AI-генерацией и ручным редактированием через админ-панель
- **Система подписок:** FREE, TEST_PRO, PRO, ULTRA с различными лимитами и возможностями
- **Админ-панель:** Полное управление ботом, пользователями, контентом и календарем

## Технологический стек

- **Backend:** Python 3.11+ (aiogram 3.x)
- **БД:** PostgreSQL + Redis (кеширование и очереди)
- **AI:** OpenAI GPT-4 / Claude для анализа и категоризации
- **Парсинг:** pandas, aiohttp, BeautifulSoup4/Playwright
- **Админка:** Flask-Admin
- **Платежи:** Boosty API
- **Деплой:** Railway (основной) / VPS (резервный)

## Установка и запуск

### Локальная разработка

1. **Клонируйте репозиторий:**
```bash
git clone <repository-url>
cd IQStocker-cursor2
```

2. **Создайте виртуальное окружение:**
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

3. **Установите зависимости:**
```bash
pip install -r requirements.txt
```

4. **Настройте переменные окружения:**
```bash
cp env.example .env
# Отредактируйте .env файл с вашими настройками
```

5. **Инициализируйте базу данных:**
```bash
python init_db.py
```

6. **Создайте админского пользователя:**
```bash
python setup_admin_user.py
```

7. **Запустите бота:**
```bash
python bot/main.py
```

### Развертывание на Railway

Для продакшена рекомендуется использовать Railway. Подробная инструкция доступна в [DEPLOYMENT_RAILWAY.md](DEPLOYMENT_RAILWAY.md).

**Быстрый старт на Railway:**
1. Подключите репозиторий к Railway
2. Добавьте PostgreSQL и Redis
3. Настройте переменные окружения (см. `env.railway.example`)
4. Деплой автоматически инициализирует БД и запустит бота

### Новые возможности

#### Определение новых работ по ID
- Работы с ID, начинающимися на "150" (10 цифр), автоматически определяются как новые
- Конфигурируемый параметр `NEW_WORKS_MONTHS` для альтернативного определения по дате

#### Система управления календарем
- **AI-генерация:** Автоматическое создание календаря с помощью OpenAI GPT-4
- **Шаблоны:** Резервные шаблоны для каждого месяца
- **Ручное редактирование:** Полный контроль через админ-панель
- **Автоматическое обновление:** Ежемесячная генерация календаря (25 числа)

#### Админ-панель
- **Управление календарем:** Создание, редактирование, удаление календарных записей
- **Статистика пользователей:** Подробная аналитика по подпискам и активности
- **Система рассылок:** Массовые уведомления с фильтрацией по подпискам
- **Мониторинг:** Отслеживание состояния системы и производительности
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
```

7. **Запустите бота:**
```bash
python main.py
```

### Docker

1. **Запустите с Docker Compose:**
```bash
docker-compose up -d
```

### Railway

1. **Подключите репозиторий к Railway**
2. **Добавьте переменные окружения:**
   - `TELEGRAM_BOT_TOKEN` - токен бота от @BotFather
   - `DATABASE_URL` - URL PostgreSQL базы данных
   - `REDIS_URL` - URL Redis для кеширования
   - `OPENAI_API_KEY` - API ключ OpenAI
   - `BOOSTY_WEBHOOK_SECRET` - секрет для webhook Boosty
3. **Настройте PostgreSQL и Redis addons**
4. **Деплой произойдет автоматически**

### Структура сервисов

- **bot/main.py** - основной Telegram бот
- **core/notifications/scheduler.py** - Celery воркер и планировщик
- **admin/app.py** - веб-админ панель
- **api/webhooks/boosty.py** - webhook для платежей

### Мониторинг

- Логи: `logs/` директория
- Метрики: админ-панель на порту 5000
- Health check: `/health` endpoint

## Переменные окружения

Обязательные переменные:

- `BOT_TOKEN` - токен Telegram бота
- `DATABASE_URL` - URL PostgreSQL базы данных
- `REDIS_URL` - URL Redis
- `ADMIN_SECRET_KEY` - секретный ключ для админ-панели
- `ADMIN_USERNAME` - имя пользователя админ-панели
- `ADMIN_PASSWORD` - пароль админ-панели

Опциональные переменные:

- `OPENAI_API_KEY` - ключ OpenAI API
- `ANTHROPIC_API_KEY` - ключ Anthropic API
- `BOOSTY_CLIENT_ID` - ID клиента Boosty
- `BOOSTY_CLIENT_SECRET` - секрет клиента Boosty
- `BOOSTY_WEBHOOK_SECRET` - секрет webhook Boosty
- `SENTRY_DSN` - DSN для Sentry
- `DEBUG` - режим отладки (True/False)

## Структура проекта

```
IQStocker-cursor2/
├── bot/                      # Telegram бот
│   ├── handlers/            # Обработчики команд и callback
│   ├── keyboards/           # Клавиатуры и меню
│   ├── middlewares/         # Middleware (подписки, лимиты)
│   ├── states/              # FSM состояния
│   └── utils/               # Вспомогательные функции
├── core/                     # Бизнес-логика
│   ├── analytics/           # Анализ CSV и метрики
│   ├── parser/              # Парсинг Adobe Stock
│   ├── ai/                  # AI агенты (категоризация, темы)
│   ├── subscriptions/       # Управление подписками
│   └── notifications/       # Система уведомлений
├── database/                 # База данных
│   ├── models/              # SQLAlchemy модели
│   ├── migrations/          # Alembic миграции
│   └── repositories/        # Репозитории для работы с БД
├── admin/                    # Админ-панель
│   ├── views/               # Представления админки
│   └── forms/               # Формы для админки
├── api/                      # API endpoints
│   └── webhooks/            # Webhook для Boosty
├── config/                   # Конфигурация
├── tests/                    # Тесты
└── requirements.txt
```

## Подписки

### FREE
- 1 тема в неделю
- Сокращенный календарь стокера
- Только базовые видеоуроки

### TEST_PRO (14 дней)
- 1 аналитика
- 5 тем в неделю
- Топ-5 тем
- Календарь стокера (расширенный)
- Все видеоуроки

### PRO
- 2 аналитики/мес
- 5 тем в неделю
- Топ-5 тем
- Календарь стокера (расширенный)
- Все видеоуроки

### ULTRA
- 4 аналитики/мес
- 10 тем в неделю
- Топ-10 тем
- Календарь стокера (расширенный)
- Все видеоуроки

## Админ-панель

Админ-панель доступна по адресу `/admin` (порт 5000).

Функции:
- Управление пользователями
- Просмотр подписок и лимитов
- Управление видеоуроками
- Управление календарем
- Рассылка сообщений

## API

### Webhook Boosty
- `POST /webhook/boosty` - обработка платежей от Boosty

### Health Check
- `GET /health` - проверка состояния сервиса

## Разработка

### Запуск тестов
```bash
pytest
```

### Форматирование кода
```bash
black .
isort .
```

### Линтинг
```bash
flake8
```

## Лицензия

MIT License

## Поддержка

Для получения поддержки обращайтесь:
- Email: [email]
- Telegram: [@ник]
