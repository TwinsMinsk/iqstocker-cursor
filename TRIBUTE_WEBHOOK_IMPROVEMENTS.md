# –£–ª—É—á—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Tribute Webhook

## –î–∞—Ç–∞: 2025-11-19

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

### 1. ‚ùå –ö—Ä–∏—Ç–∏—á–Ω–æ: –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `expires_at` –æ—Ç Tribute

**–ë—ã–ª–æ:**
```python
expires_at = datetime.utcnow() + timedelta(days=30)  # –í–°–ï–ì–î–ê 30 –¥–Ω–µ–π!
```

**–°—Ç–∞–ª–æ:**
```python
# –ò–∑–≤–ª–µ–∫–∞–µ–º expires_at –æ—Ç Tribute (–µ—Å–ª–∏ –µ—Å—Ç—å)
expires_at = None
if is_subscription and 'expires_at' in payload:
    expires_at_str = payload.get('expires_at')
    if expires_at_str:
        expires_at = datetime.fromisoformat(expires_at_str.replace('Z', '+00:00'))
        expires_at = expires_at.replace(tzinfo=None)  # naive datetime –¥–ª—è –ë–î

# –í PaymentHandler –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–ª–∏ expires_at –æ—Ç Tribute, –∏–ª–∏ +30 –¥–Ω–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:**
- Tribute –ø–µ—Ä–µ–¥–∞–µ—Ç —Ç–æ—á–Ω—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ø–æ–ª–µ `expires_at`
- –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ 30 –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, yearly –ø–æ–¥–ø–∏—Å–∫–∏ = 365 –¥–Ω–µ–π)
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–æ–ª—è –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –¥–∞—Ç–∞–º –∏—Å—Ç–µ—á–µ–Ω–∏—è

### 2. ‚ùå –ù–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–æ—Å—å —Å–æ–±—ã—Ç–∏–µ `cancelled_subscription`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
```python
elif event_name == 'cancelled_subscription':
    print("–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ cancelled_subscription")
    await self._handle_cancelled_subscription(data)
```

**–ù–æ–≤—ã–π –º–µ—Ç–æ–¥:**
```python
async def _handle_cancelled_subscription(self, data: Dict[str, Any]):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏."""
    payload = data.get('payload', {})
    
    telegram_user_id = payload.get('telegram_user_id')
    subscription_id = payload.get('subscription_id')
    
    print(f"üö´ –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏:")
    print(f"   User: {telegram_user_id}")
    print(f"   Subscription ID: {subscription_id}")
    
    # –ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –¥–æ expires_at, –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ
```

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

### `api/webhooks/tribute.py`

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `datetime`
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è `cancelled_subscription`
3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ `expires_at` –∏–∑ payload
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `expires_at` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `process_payment_success()`
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_handle_cancelled_subscription()`

### `core/subscriptions/payment_handler.py`

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `expires_at: Optional[datetime] = None`
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `expires_at` –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
3. ‚úÖ Fallback –Ω–∞ +30 –¥–Ω–µ–π, –µ—Å–ª–∏ `expires_at` –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω
4. ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å

### ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

1. **`new_subscription`** - –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `telegram_user_id`, `subscription_id`, `amount`, `currency`
   - **–ö–†–ò–¢–ò–ß–ù–û:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `expires_at` –æ—Ç Tribute
   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏ (PRO/ULTRA)
   - –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —Å—É–º–º–∞ –≤ EUR
   - –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –≤ –ë–î

2. **`cancelled_subscription`** - –æ—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
   - –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –¥–æ `expires_at`
   - –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è

3. **`new_digital_product`** - –ø–æ–∫—É–ø–∫–∞ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–æ–¥–ø–∏—Å–∫–µ

### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ HMAC-SHA256** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏
2. **Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
3. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ª–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –Ω–µ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –¥–∞–Ω–Ω—ã–º–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–π endpoint

```bash
POST /webhook/tribute/test
Form data:
  telegram_user_id=123456789
  subscription_type=ULTRA
  payment_id=test_payment_123
  amount=4.0
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π webhook
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
   ```
   ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º expires_at –æ—Ç Tribute: 2025-12-19 12:34:56
   –ü–æ–¥–ø–∏—Å–∫–∞ Tribute (ULTRA) —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è user 123456789
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ - –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∞—Ç–æ–π

## –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Tribute

–°–æ–≥–ª–∞—Å–Ω–æ [–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Tribute](https://wiki.tribute.tg/for-content-creators/api-documentation/webhooks):

### ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ webhook

```json
{
  "name": "new_subscription",
  "created_at": "2025-08-25T01:15:58.33246Z",
  "sent_at": "2025-08-25T01:15:58.542279448Z",
  "payload": {
    "subscription_name": "Support creativity üåü",
    "subscription_id": 1644,
    "period": "monthly",
    "price": 1000,
    "amount": 700,
    "currency": "eur",
    "telegram_user_id": 12321321,
    "expires_at": "2025-04-20T01:15:57.305733Z"  // ‚Üê –ö–†–ò–¢–ò–ß–ù–û!
  }
}
```

### ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ –ø–æ–ª—è

- ‚úÖ `name` - —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
- ‚úÖ `payload.telegram_user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `payload.subscription_id` / `product_id` - ID –ø–ª–∞—Ç–µ–∂–∞
- ‚úÖ `payload.amount` - —Å—É–º–º–∞ –≤ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö (—Ü–µ–Ω—Ç—ã/–∫–æ–ø–µ–π–∫–∏)
- ‚úÖ `payload.currency` - –≤–∞–ª—é—Ç–∞ (eur/usd/rub)
- ‚úÖ `payload.expires_at` - **–ö–†–ò–¢–ò–ß–ù–û: –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è** ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û!
- ‚úÖ `payload.subscription_name` / `product_name` - –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏

```python
expected_signature = hmac.new(
    self.webhook_secret.encode(),
    payload.encode(),
    hashlib.sha256
).hexdigest()

return hmac.compare_digest(signature, expected_signature)
```

### ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∞–ª—é—Ç

- **EUR:** `amount / 100` (—Ü–µ–Ω—Ç—ã ‚Üí –µ–≤—Ä–æ)
- **USD:** `(amount / 100) * 0.92` (–¥–æ–ª–ª–∞—Ä—ã ‚Üí –µ–≤—Ä–æ)
- **RUB:** `(amount / 100) * 0.01` (—Ä—É–±–ª–∏ ‚Üí –µ–≤—Ä–æ)

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è production

1. ‚úÖ **Webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω** –≤ Tribute Dashboard
2. ‚úÖ **API Key —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω** –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `PAYMENT_TRIBUTE_API_KEY`
3. ‚úÖ **Endpoint –¥–æ—Å—Ç—É–ø–µ–Ω** –ø–æ –∞–¥—Ä–µ—Å—É `https://your-domain/webhook/tribute`

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

1. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ:
   ```
   ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º expires_at –æ—Ç Tribute: ...
   –ü–æ–¥–ø–∏—Å–∫–∞ Tribute (ULTRA) —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è user ...
   ```

2. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ:
   ```
   ‚ÑπÔ∏è expires_at –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º +30 –¥–Ω–µ–π
   ```
   - –≠—Ç–æ fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –∏–ª–∏ —Ç–µ—Å—Ç–æ–≤

### –ù–∞ –±—É–¥—É—â–µ–µ

1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ë–î** - –¥–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ `auto_renew`
2. **Webhook retry logic** - Tribute –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —á–µ—Ä–µ–∑ 5m, 15m, 30m, 1h, 10h
3. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—Ç–º–µ–Ω–µ** - –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏ `cancelled_subscription`

## –ò—Ç–æ–≥

‚úÖ **100% —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Tribute**
‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `expires_at` –æ—Ç Tribute**
‚úÖ **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏**
‚úÖ **–£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
‚úÖ **Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã**
‚úÖ **–ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞**

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ

