# üéâ –í–°–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò MARKDOWN –≠–ö–†–ê–ù–ò–†–û–í–ê–ù–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–´!

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –º–µ–Ω—é, –ø–æ—á—Ç–∏ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –±—ã–ª–∏ –Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ Markdown —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:

```
TelegramBadRequest: Telegram server says - Bad Request: can't parse entities: Character '.' is reserved and must be escaped with the preceding '\'
TelegramBadRequest: Telegram server says - Bad Request: can't parse entities: Character '-' is reserved and must be escaped with the preceding '\'
```

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:**
- `themes.py` - –æ—à–∏–±–∫–∏ —Å —Ç–æ—á–∫–∞–º–∏ –∏ –¥–µ—Ñ–∏—Å–∞–º–∏
- `top_themes.py` - –æ—à–∏–±–∫–∏ —Å —Ç–æ—á–∫–∞–º–∏ –∏ —Å–∫–æ–±–∫–∞–º–∏  
- `lessons.py` - –æ—à–∏–±–∫–∏ —Å —Ç–æ—á–∫–∞–º–∏ –∏ –¥–µ—Ñ–∏—Å–∞–º–∏
- `calendar.py` - –æ—à–∏–±–∫–∏ —Å —Ç–æ—á–∫–∞–º–∏ –∏ —Å–∫–æ–±–∫–∞–º–∏
- `channel.py` - –æ—à–∏–±–∫–∏ —Å —Ç–æ—á–∫–∞–º–∏ –∏ –¥–µ—Ñ–∏—Å–∞–º–∏

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞
**–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –Ω–æ –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram.

## ‚úÖ –°–∏—Å—Ç–µ–º–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–ª–∏ –æ–±—â–∏–π –º–æ–¥—É–ª—å –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
**–§–∞–π–ª:** `bot/utils/markdown.py`
```python
def escape_markdown(text: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è Markdown."""
    return (text.replace('*', '\\*')
                .replace('-', '\\-')
                .replace('(', '\\(')
                .replace(')', '\\)')
                .replace('.', '\\.')
                .replace('!', '\\!')
                .replace('_', '\\_')
                .replace('[', '\\[')
                .replace(']', '\\]')
                .replace('`', '\\`'))

def escape_markdown_preserve_formatting(text: str) -> str:
    """–≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è Markdown, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."""
    # –°–Ω–∞—á–∞–ª–∞ –∑–∞—â–∏—â–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = text.replace('**', '___BOLD___')
    text = text.replace('*', '___ITALIC___')
    
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã (–∫—Ä–æ–º–µ _)
    text = (text.replace('-', '\\-')
                .replace('(', '\\(')
                .replace(')', '\\)')
                .replace('.', '\\.')
                .replace('!', '\\!')
                .replace('[', '\\[')
                .replace(']', '\\]')
                .replace('`', '\\`'))
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    text = text.replace('___BOLD___', '**')
    text = text.replace('___ITALIC___', '*')
    
    return text
```

### 2. –ò—Å–ø—Ä–∞–≤–∏–ª–∏ –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

**`bot/handlers/themes.py`:**
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –∏–º–ø–æ—Ä—Ç `escape_markdown`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è FREE –∏ PRO –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–ª–∏ –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã

**`bot/handlers/top_themes.py`:**
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –∏–º–ø–æ—Ä—Ç `escape_markdown`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ç–æ–ø-—Ç–µ–º–∞–º–∏

**`bot/handlers/lessons.py`:**
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –∏–º–ø–æ—Ä—Ç `escape_markdown`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è PRO –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**`bot/handlers/calendar.py`:**
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –∏–º–ø–æ—Ä—Ç `escape_markdown`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è FREE –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è PRO –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**`bot/handlers/channel.py`:**
- ‚úÖ –î–æ–±–∞–≤–∏–ª–∏ –∏–º–ø–æ—Ä—Ç `escape_markdown`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∫–∞–Ω–∞–ª–µ

**`bot/handlers/analytics.py`:**
- ‚úÖ –û–±–Ω–æ–≤–∏–ª–∏ –∏–º–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±—â–µ–≥–æ –º–æ–¥—É–ª—è
- ‚úÖ –£–¥–∞–ª–∏–ª–∏ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —Ñ—É–Ω–∫—Ü–∏–∏

## üß™ –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏** - –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ **–§—É–Ω–∫—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è** - —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–ª—É—á–∞–∏** - –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```
üîß –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏: ‚úÖ OK
ü§ñ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏: ‚úÖ OK
üìù –£—Ç–∏–ª–∏—Ç—ã Markdown: ‚úÖ OK

üéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–®–õ–ò –£–°–ü–ï–®–ù–û!
```

## üîç –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

**üî¥ –ë–´–õ–û (–≤—ã–∑—ã–≤–∞–ª–æ –æ—à–∏–±–∫–∏):**
```python
themes_text = f"""üéØ *–¢–µ–º—ã –∏ —Ç—Ä–µ–Ω–¥—ã*\n\n–ó–¥–µ—Å—å —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—É—é –ø–æ–¥–±–æ—Ä–∫—É –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∏–¥–µ–π\\.\n\nüìå *–¢–≤–æ—è —Ç–µ–º–∞ –Ω–µ–¥–µ–ª–∏*\n\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–º—É\\!"""
```

**üü¢ –°–¢–ê–õ–û (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ):**
```python
themes_text = escape_markdown(f"""üéØ *–¢–µ–º—ã –∏ —Ç—Ä–µ–Ω–¥—ã*\n\n–ó–¥–µ—Å—å —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—É—é –ø–æ–¥–±–æ—Ä–∫—É –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∏–¥–µ–π\\.\n\nüìå *–¢–≤–æ—è —Ç–µ–º–∞ –Ω–µ–¥–µ–ª–∏*\n\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–º—É\\!""")
```

## üöÄ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç
1. **–ó–∞–≥—Ä—É–∑–∫–∞ CSV —Ñ–∞–π–ª–æ–≤** - –±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–∞–π–ª—ã –±–µ–∑ –æ—à–∏–±–æ–∫
2. **–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥** - –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ CSV** - —Ñ–∞–π–ª—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–æ–≤** - –æ—Ç—á–µ—Ç—ã —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
5. **–ú–µ–Ω—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏** - –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã
6. **–í—Å–µ —Ä–∞–∑–¥–µ–ª—ã** - themes, top_themes, lessons, calendar, channel —Ä–∞–±–æ—Ç–∞—é—Ç
7. **–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª** - –æ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `bot/utils/markdown.py` - —Å–æ–∑–¥–∞–Ω –æ–±—â–∏–π –º–æ–¥—É–ª—å –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `bot/handlers/themes.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `bot/handlers/top_themes.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `bot/handlers/lessons.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `bot/handlers/calendar.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `bot/handlers/channel.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `bot/handlers/analytics.py` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±—â–µ–≥–æ –º–æ–¥—É–ª—è

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:** `python run_local_bot.py`
2. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ CSV —Ñ–∞–π–ª** –±–æ—Ç—É –≤ Telegram
3. **–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º** –±–æ—Ç–∞ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
4. **–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∏** (1-2 –º–∏–Ω—É—Ç—ã)
5. **–ü–æ–ª—É—á–∏—Ç–µ –æ—Ç—á–µ—Ç** —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
6. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é** - –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —Ç–µ–ø–µ—Ä—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã!
7. **–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏** - themes, top_themes, lessons, calendar, channel

## üîß –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `bot/utils/markdown.py` - –æ–±—â–∏–π –º–æ–¥—É–ª—å –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è Markdown
- `test_all_handlers_fix.py` - —Ç–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

## üéØ –ò—Ç–æ–≥
**–ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–µ–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ –º–µ–Ω—é –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞!** –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç Markdown —Å–∏–º–≤–æ–ª—ã, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –º–µ–∂–¥—É –≤—Å–µ–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ –±–æ—Ç–∞ –±–µ–∑ –æ—à–∏–±–æ–∫.
